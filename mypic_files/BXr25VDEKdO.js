/*!CK:2186593723!*//*1375705728,173205831*/

if (self.CavalryLogger) { CavalryLogger.start_js(["zBhY6"]); }

__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={JEWEL:"jewel",CHAT:"chat",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};});
__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNCONFIRMED:3,UNSENT:0,RESENDING:7,RESENT:6,UNABLE_TO_CONFIRM:5,FAILED_UNKNOWN_REASON:4,SUCCESS:1,ERROR:10};});
__d("MercuryActionTypeConstants",[],function(a,b,c,d,e,f){e.exports={LOG_MESSAGE:"ma-type:log-message",CLEAR_CHAT:"ma-type:clear_chat",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",CHANGE_FOLDER:"ma-type:change-folder",SEND_MESSAGE:"ma-type:send-message",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",DELETE_THREAD:"ma-type:delete-thread",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings"};});
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"attach:unknown",PHOTO:"attach:image",VIDEO:"attach:video",MSWORD:"attach:ms:word",VOICE:"attach:voice",MSPPT:"attach:ms:ppt",TEXT:"attach:text",MUSIC:"attach:music",MSXLS:"attach:ms:xls"};});
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={STICKER:"sticker",PHOTO:"photo",FILE:"file",SHARE:"share",ERROR:"error"};});
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};});
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={PENDING_THREAD_ID:"pending:pending"};});
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};});
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SERVER_ERROR:"log:error-msg",UNSUBSCRIBE:"log:unsubscribe",JOINABLE_JOINED:"log:joinable-joined",JOINABLE_CREATED:"log:joinable-created",LIVE_LISTEN:"log:live-listen",PHONE_CALL:"log:phone-call",THREAD_IMAGE:"log:thread-image",THREAD_NAME:"log:thread-name",VIDEO_CALL:"log:video-call",SUBSCRIBE:"log:subscribe"};});
__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){e.exports={FRIEND:"friend",USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page"};});
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={SERVER_INITIAL_DATA:"server_initial_data",CLIENT_DELETE_THREAD:"client_delete_thread",SERVER_SAVE_DRAFT:"server_save_draft",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_SEARCH:"server_search",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_MARK_SEEN:"server_mark_seen",SERVER_THREAD_SYNC:"server_thread_sync",CLIENT_DELETE_MESSAGES:"client_delete_messages",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_SEND_MESSAGE:"server_send_message",CLIENT_SAVE_DRAFT:"client_save_draft",UNKNOWN:"unknown",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_TAB_PRESENCE:"server_tab_presence",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_HANDLE_ERROR:"client_handle_error"};});
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",WEBRTC_MOBILE:"source:webrtc:mobile",GIGABOXX_API:"source:gigaboxx:api",TITAN_M_JAPAN:"source:titan:m_japan",BUFFY_SMS:"source:buffy:sms",SEND_PLUGIN:"source:sendplugin",CHAT_MEEBO:"source:chat:meebo",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TEST:"source:test",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_EMAIL_REPLY:"source:titan:emailreply",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_ORCA:"source:titan:orca",TITAN_M_TOUCH:"source:titan:m_touch",CHAT:"source:chat",CHAT_IPHONE:"source:chat:iphone",TITAN_WEB:"source:titan:web",UNKNOWN:"source:unknown",TITAN_M_MINI:"source:titan:m_mini",GIGABOXX_MOBILE:"source:gigaboxx:mobile",HELPCENTER:"source:helpcenter",PAID_PROMOTION:"source:paid_promotion",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",TITAN_M_TALK:"source:titan:m_talk",GIGABOXX_BLAST:"source:gigaboxx:blast",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",CHAT_WEB:"source:chat:web",TITAN_M_TABLET:"source:titan:m_tablet",WEB:"source:web",SOCIALFOX:"source:socialfox",EMAIL:"source:email",TITAN_API:"source:titan:api",GIGABOXX_WEB:"source:gigaboxx:web",DESKTOP:"source:desktop",LEIA:"source:leia",CHAT_JABBER:"source:chat:jabber",CHAT_TEST:"source:chat:test",SHARE_DIALOG:"source:share:dialog",GIGABOXX_WAP:"source:gigaboxx:wap",MOBILE:"source:mobile",TITAN_M_APP:"source:titan:m_app",TITAN_WAP:"source:titan:wap",SMS:"source:sms",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_ZERO:"source:titan:m_zero",NEW_SHARE_DIALOG:"source:share:dialog:new",CHAT_ORCA:"source:chat:orca"};});
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,OBJECT_ORIGINATED:3,TITAN_ORIGINATED:2};});
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={MTA_SYSTEM_MESSAGE:"MTA:system_message",SENT:"sent",INBOX:"inbox",SMS_TAG_ROOT:"SMSShortcode:",UPDATES:"broadcasts_inbox",OTHER:"other",GROUPS:"groups",FILTERED_CONTENT:"filtered_content",ACTION_ARCHIVED:"action:archived",UNREAD:"unread",BCC:"header:bcc",SMS_MUTE:"sms_mute",ARCHIVED:"archived",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",EVENT:"event",VOICEMAIL:"voicemail",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SPAM:"spam",EMAIL_MESSAGE:"source:email",EMAIL:"email",APP_ID_ROOT:"app_id:"};});
__d("PresenceUtil",["Cookie","Env","randomInt","tx"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Env'),i=b('randomInt'),j=b('tx'),k=i(0,4294967295)+1,l={checkMaintenanceError:function(m){if(m.getError()==1356007)return true;return false;},getErrorDescription:function(m){var n=m.getError(),o=m.getErrorDescription();if(!o)o="An error occurred.";if(n==1357001)o="Your session has timed out. Please log in.";return o;},getSessionID:function(){return k;},hasUserCookie:function(){return h.user===g.get('c_user');}};e.exports=l;});
__d("PresencePrivacy",["Arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","PresenceUtil","PresencePrivacyInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChannelConstants'),j=b('copyProperties'),k=b('Env'),l=b('JSLogger'),m=b('PresenceUtil'),n=b('PresencePrivacyInitialData'),o='/ajax/chat/privacy/settings.php',p='/ajax/chat/privacy/online_policy.php',q='/ajax/chat/privacy/visibility.php',r='friend_visibility',s='visibility',t='online_policy',u=j({},n.privacyData),v=n.visibility,w=j({},n.privacyData),x=v,y=n.onlinePolicy,z=y,aa=[],ba=false;function ca(){return l.create('blackbird');}var da=j(new g(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function ea(qa){var ra;for(ra in qa){var sa=qa[ra];if(ra==k.user){ca().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(sa){case da.WHITELISTED:case da.BLACKLISTED:case da.UNLISTED:break;default:ca().error('set_invalid_friend_visibility',{id:ra,value:sa});throw new Error("Invalid state: "+sa);}}for(ra in qa)u[ra]=qa[ra];da.inform('privacy-changed');}function fa(qa,ra){var sa={};sa[qa]=ra;ea(sa);}function ga(qa){switch(qa){case da.ONLINE:case da.OFFLINE:break;default:ca().error('set_invalid_visibility',{value:qa});throw new Error("Invalid visibility: "+qa);}v=qa;da.inform('privacy-changed');da.inform('privacy-user-presence-changed');g.inform('chat/visibility-changed',{sender:this});}function ha(qa){switch(qa){case da.ONLINE_TO_WHITELIST:case da.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+qa);}y=qa;da.inform('privacy-user-presence-changed');da.inform('privacy-changed');}function ia(qa,ra){ba=true;qa.send();}function ja(qa,ra){aa.push({request:qa,data:ra});if(!ba){var sa=aa.shift();ia(sa.request,sa.data);}}function ka(qa,ra){var sa=qa.type;if(sa===r){var ta=ra.payload.user_availabilities;if(!Array.isArray(ta)){da.inform('privacy-availability-changed',{user_availabilities:ta});for(var ua in qa.settings)w[ua]=qa.settings[ua];}}else{if(sa===s){x=qa.visibility;}else if(sa===t)z=qa.online_policy;da.inform('privacy-user-presence-response');}ca().log('set_update_response',{data:qa,response:ra});}function la(qa,ra){if(v!==x)ga(x);if(y!==z)ha(z);j(u,w);da.inform('privacy-changed');aa=[];ca().log('set_error_response',{data:qa,response:ra});}function ma(qa){ba=false;if(aa.length>0){var ra=aa.shift();ia(ra.request,ra.data);}}function na(qa,ra){if(m!=null){var sa=qa.getData();sa.window_id=m.getSessionID();qa.setData(sa);}qa.setHandler(ka.bind(this,ra)).setErrorHandler(la.bind(this,ra)).setTransportErrorHandler(la.bind(this,ra)).setFinallyHandler(ma.bind(this)).setAllowCrossPageTransition(true);return qa;}function oa(qa,ra,sa){return na(new h(qa).setData(ra),sa);}function pa(qa,ra){var sa=ra.obj;if(sa.viewer_id!=k.user){ca().error('invalid_viewer_for_channel_message',{type:qa,data:ra});throw new Error("Viewer got from the channel is not the real viewer");}if(sa.window_id===m.getSessionID())return;var ta=sa.data;if(sa.event=='access_control_entry'){ta.target_ids.forEach(function(va){fa(va,ta.setting);w[va]=ta.setting;});}else{if(sa.event=='visibility_update'){var ua=!!ta.visibility?da.ONLINE:da.OFFLINE;ga(ua);x=ua;}else if(sa.event=='online_policy_update'){ha(ta.online_policy);z=ta.online_policy;}da.inform('privacy-user-presence-response');}ca().log('channel_message_received',{data:ra.obj});}j(da,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(qa,ra,sa){},setVisibility:function(qa){x=v;ga(qa);var ra={visibility:qa},sa={type:s,visibility:qa},ta=oa(q,ra,sa);ja(ta,sa);ca().log('set_visibility',{data:ra});return qa;},getVisibility:function(){return v;},setOnlinePolicy:function(qa){z=y;ha(qa);var ra={online_policy:qa},sa={type:t,online_policy:qa},ta=oa(p,ra,sa);ja(ta,sa);ca().log('set_online_policy',{data:ra});return qa;},getOnlinePolicy:function(){return y;},getFriendVisibility:function(qa){return u[qa]||da.UNLISTED;},allows:function(qa){if(this.getVisibility()===da.OFFLINE)return false;var ra=this.getOnlinePolicy();return ra===da.ONLINE_TO_WHITELIST?u[qa]==da.WHITELISTED:u[qa]!=da.BLACKLISTED;},setFriendsVisibility:function(qa,ra){if(qa.length>0){var sa={};for(var ta=0;ta<qa.length;ta++){var ua=qa[ta];w[ua]=u[ua];sa[ua]=ra;}ea(sa);var va=ra;if(va==da.UNLISTED)va=w[qa[0]];var wa={users:qa,setting:ra,setting_type:va},xa={type:r,settings:sa},ya=oa(o,wa,xa);ja(ya,xa);ca().log('set_friend_visibility',{data:wa});}return ra;},setFriendVisibilityMap:function(qa,ra){for(var sa in qa)w[sa]=u[sa];ea(qa);var ta={type:r,settings:qa};ja(na(ra,ta),ta);ca().log('set_friend_visibility_from_map',{data:qa});},allow:function(qa){if(this.allows(qa)){ca().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===da.OFFLINE){ca().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var ra=this.getOnlinePolicy()===da.ONLINE_TO_WHITELIST?da.WHITELISTED:da.UNLISTED;return this.setFriendsVisibility([qa],ra);},disallow:function(qa){if(!this.allows(qa)){ca().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===da.OFFLINE){ca().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var ra=this.getOnlinePolicy()===da.ONLINE_TO_BLACKLIST?da.BLACKLISTED:da.UNLISTED;return this.setFriendsVisibility([qa],ra);},getBlacklist:function(){var qa=[];for(var ra in u)if(u[ra]===da.BLACKLISTED)qa.push(ra);return qa;},getWhitelist:function(){var qa=[];for(var ra in u)if(u[ra]===da.WHITELISTED)qa.push(ra);return qa;},getMapForTest:function(){return u;},setMapForTest:function(qa){u=qa;}});da.inform('privacy-changed');da.inform('privacy-user-presence-changed');ca().log('initialized',{visibility:v,policy:y});g.subscribe(i.getArbiterType('privacy_changed'),pa.bind(this));g.subscribe(i.ON_CONFIG,function(qa,ra){var sa=ra.getConfig('visibility',null);if(sa!==null&&typeof(sa)!=='undefined'){var ta=sa?da.ONLINE:da.OFFLINE;ga(ta);ca().log('config_visibility',{vis:ta});}}.bind(this));a.PresencePrivacy=e.exports=da;},3);
__d("ChatVisibility",["Arbiter","JSLogger","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('JSLogger'),i=b('PresencePrivacy'),j={isOnline:function(){return i.getVisibility()===i.ONLINE;},hasBlackbirdEnabled:function(){return this.isVisibleToMostFriends()||this.isVisibleToSomeFriends();},isVisibleToMostFriends:function(){return i.getOnlinePolicy()===i.ONLINE_TO_BLACKLIST&&i.getBlacklist().length>0;},isVisibleToSomeFriends:function(){return i.getOnlinePolicy()===i.ONLINE_TO_WHITELIST&&i.getWhitelist().length>0;},goOnline:function(k){if(i.getVisibility()===i.OFFLINE){h.create('blackbird').log('chat_go_online');i.setVisibility(i.ONLINE);g.inform('chat-visibility/go-online');}k&&k();},goOffline:function(k){if(i.getVisibility()===i.ONLINE){h.create('blackbird').log('chat_go_offline');i.setVisibility(i.OFFLINE);g.inform('chat-visibility/go-offline');}k&&k();},toggleVisibility:function(){if(j.isOnline()){j.goOffline();}else j.goOnline();}};a.ChatVisibility=e.exports=j;},3);
__d("MercurySingletonMixin",["Env"],function(a,b,c,d,e,f){var g=b('Env'),h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.user);},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;});
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("ImageSourceType",[],function(a,b,c,d,e,f){var g={PROFILE_PICTURE:'profile_picture',IMAGE:'image'};e.exports=g;});
__d("PhotoResizeModeConst",[],function(a,b,c,d,e,f){var g={COVER:'s',CONTAIN:'p'};e.exports=g;});
__d("ImageSourceRequest",["arrayContains","extendArray","copyProperties","Env","KeyedCallbackManager","ImageSourceType","PhotoResizeModeConst","MercuryServerDispatcher"],function(a,b,c,d,e,f){var g=b('arrayContains'),h=b('extendArray'),i=b('copyProperties'),j=b('Env'),k=b('KeyedCallbackManager'),l=b('ImageSourceType'),m=b('PhotoResizeModeConst'),n=b('MercuryServerDispatcher');function o(){this._request={fbid:null,type:null,width:null,height:null,resize_mode:null};this._callback=null;}i(o.prototype,{setFBID:function(s){this._request.fbid=s;return this;},setType:function(s){if(!g([l.PROFILE_PICTURE,l.IMAGE],s))throw new TypeError('ImageSourceRequest.setType: invalid type '+s);this._request.type=s;return this;},setDimensions:function(s,t){this._request.width=s;this._request.height=t;return this;},setResizeMode:function(s){if(!g([m.COVER,m.CONTAIN],s))throw new TypeError('ImageSourceRequest.setResizeMode: invalid resize mode '+s);this._request.resize_mode=s;return this;},setCallback:function(s){this._callback=s;return this;},send:function(){if(!this._request.fbid||!this._request.width||!this._request.height||!this._request.type||!this._request.resize_mode||!this._callback)throw new Error('ImageSourceRequest: You must set all the fields');var s=q(),t=r(this._request);s.executeOrEnqueue(t,this._callback);if(s.getUnavailableResourcesFromRequest(t).length===1){n.trySend('/ajax/image_source.php',{requests:[this._request]});return true;}return false;}});var p=null;function q(){if(p)return p;var s=new k();p=s;n.registerEndpoints({'/ajax/image_source.php':{request_user_id:j.user,mode:n.BATCH_DEFERRED_MULTI,batch_function:function(t,u){h(t.requests,u.requests);return t;},handler:function(t,u){var v=u.getData().requests;for(var w=0;w<v.length;++w)s.setResource(r(v[w]),t[w]);}}});return s;}function r(s){return [s.fbid,s.type,s.width,s.height,s.resize_mode].join('|');}e.exports=o;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(i){return typeof i==='string'&&i.indexOf(':')!==-1;}var h={isValid:function(i){if(!i)return false;return g(i);},isValidThreadID:function(i){if(!h.isValid(i))return false;var j=h.tokenize(i);switch(j.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(i){if(!this.isValid(i))throw 'bad_id_format';var j=i.indexOf(':');return {type:i.substr(0,j),value:i.substr(j+1)};},getUserIDFromParticipantID:function(i){if(!h.isValid(i))return null;var j=h.tokenize(i);if(j.type!='fbid')return null;return j.value;}};e.exports=h;});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MessagingReliabilityLogger",["function-extensions","PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){b('function-extensions');var g=b('PresenceUtil'),h=b('MercuryServerDispatcher'),i=b('MessagingReliabilityLoggerInitialData'),j=b('isEmpty'),k=b('setTimeoutAcrossTransitions'),l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;});
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('copyProperties'),i=b('MercuryAssert'),j=b('MercurySingletonMixin');function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};this.updatedThread(m);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;});
__d("MercuryServerRequests",["ArbiterMixin","AsyncResponse","TimestampConverter","Env","JSLogger","KeyedCallbackManager","MercuryActionTypeConstants","MercuryActionStatus","MercuryAPIArgsSource","MercuryAssert","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercuryServerRequestsConfig","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercurySingletonMixin","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncResponse'),i=b('TimestampConverter'),j=b('Env'),k=b('JSLogger'),l=b('KeyedCallbackManager'),m=b('MercuryActionTypeConstants'),n=b('MercuryActionStatus'),o=b('MercuryAPIArgsSource'),p=b('MercuryAssert'),q=b('MercuryErrorType'),r=b('MercuryGenericConstants'),s=b('MercuryGlobalActionType'),t=b('MercuryIDs'),u=b('MercuryLogMessageType'),v=b('MercuryMessageClientState'),w=b('MercuryPayloadSource'),x=b('MercuryServerRequestsConfig'),y=b('MercurySourceType'),z=b('MercuryThreadlistConstants'),aa=b('MercuryMessageIDs'),ba=b('MessagingConfig'),ca=b('MessagingReliabilityLogger'),da=b('MessagingTag'),ea=b('MercurySingletonMixin'),fa=b('MercuryServerDispatcher'),ga=b('MercuryThreadInformer'),ha=b('copyProperties'),ia=b('createObjectFrom'),ja=k.create('mercury_server'),ka=o.MERCURY;function la(tb,ub){if(ub)tb._lastActionId=i.maxValidActionID(tb._lastActionId,ub);}function ma(tb,ub){var vb=ub.thread_id,wb=tb._serverToClientIDs.getResource(vb);if(!wb){if(ub.canonical_fbid){wb='user:'+ub.canonical_fbid;}else if(ub.root_message_threading_id)wb='root:'+ub.root_message_threading_id;wb=wb||'thread:'+vb;na(tb,vb,wb);}ub.thread_id=wb;}function na(tb,ub,vb){tb._serverToClientIDs.setResource(ub,vb);tb._clientToServerIDs.setResource(vb,ub);tb._newlyAddedClientIDs[ub]=vb;}function oa(tb,ub,vb){var wb=tb._clientToServerIDs.executeOrEnqueue(ub,vb),xb=tb._clientToServerIDs.getUnavailableResources(wb),yb=tb.tokenizeThreadID(ub);if(xb.length&&yb.type!='root')tb.fetchThreadData(xb);}function pa(tb,ub){return tb._clientToServerIDs.getResource(ub);}function qa(tb,ub){return !!tb._serverToClientIDs.getResource(ub);}function ra(tb,ub){var vb=tb._serverToClientIDs.getResource(ub);if(typeof vb=='undefined')ja.warn('no_client_thread_id',{server_id:ub});return vb;}function sa(tb,ub,vb){tb._serverToClientIDs.executeOrEnqueue(ub,vb);tb.ensureThreadIsFetched(ub);}function ta(tb,ub,vb){if(ub.action_type!=m.SEND_MESSAGE)return;var wb=ub.client_thread_id;if(!wb)wb=ra(tb,ub.thread_id);var xb=null;if(wb)xb=t.tokenize(wb).type;ca.addEntry('send_'+xb,vb,ub.thread_id+','+ub.message_id);}function ua(tb){return tb.getError()?'_'+tb.getError():'';}function va(tb,ub){var vb=null;switch(ub.status){case n.SUCCESS:vb='success';break;case n.FAILED_UNKNOWN_REASON:vb='confirmed_error';break;case n.UNABLE_TO_CONFIRM:vb='confirm_error';break;default:return;}ta(tb,ub,vb);}function wa(tb,ub){(ub.message_counts||[]).forEach(function(dc){la(tb,dc.last_action_id);});(ub.threads||[]).forEach(function(dc){ma(tb,dc);delete tb._fetchingThreads[dc.thread_id];var ec=pa(tb,dc.thread_id);delete tb._fetchingThreads[ec];la(tb,dc.last_action_id);});(ub.ordered_threadlists||[]).forEach(function(dc){dc.thread_ids=dc.thread_ids.map(ra.curry(tb));});ub.actions=ub.actions||[];ub.actions.forEach(function(dc){va(tb,dc);if(dc.status&&dc.status!=n.SUCCESS&&!dc.thread_id){dc.thread_id=dc.client_thread_id;return;}if(dc.action_type==m.SEND_MESSAGE&&dc.client_thread_id&&dc.client_thread_id!=r.PENDING_THREAD_ID)na(tb,dc.thread_id,dc.client_thread_id);dc.server_thread_id=dc.thread_id;dc.thread_id=qa(tb,dc.thread_id)?ra(tb,dc.thread_id):null;la(tb,dc.action_id);});if(ub.end_of_history){var vb=[];for(var wb=0;wb<ub.end_of_history.length;wb++){var xb=ub.end_of_history[wb];if(xb.type=='user'){vb.push('user:'+xb.id);}else if(xb.type=='thread'&&qa(tb,xb.id))vb.push(ra(tb,xb.id));}ub.end_of_history=vb;}if(ub.roger){var yb={};for(var zb in ub.roger){var ac=tb._serverToClientIDs.getResource(zb);if(ac){var bc=ub.roger[zb];yb[ac]={};for(var cc in bc)yb[ac]['fbid:'+cc]=bc[cc];}}ub.roger=yb;}}function xa(tb){if(tb._pendingUpdates&&tb._pendingUpdates.length){var ub=tb._pendingUpdates[0];tb._pendingUpdates=tb._pendingUpdates.slice(1);tb.handleUpdate(ub);}}function ya(tb,ub){var vb=ha({},tb),wb;if(ub.threads){if(!vb.threads)vb.threads={};for(wb in ub.threads)vb.threads[wb]=Object.keys(ia((vb.threads[wb]||[]).concat(ub.threads[wb])));}if(ub.messages){if(!vb.messages)vb.messages={};for(wb in ub.messages){if(!vb.messages[wb])vb.messages[wb]={};for(var xb in ub.messages[wb])if(vb.messages[wb][xb]){vb.messages[wb][xb]=bb(vb.messages[wb][xb],ub.messages[wb][xb]);}else vb.messages[wb][xb]=ub.messages[wb][xb];}}vb.client=tb.client||ub.client;return vb;}function za(tb,ub){var vb=ha(ia(tb.folders,true),ia(ub.folders,true)),wb=tb.client||ub.client;return {folders:Object.keys(vb),client:wb};}function ab(tb,ub){for(var vb in ub)if(tb[vb]&&typeof tb[vb]==='object'){tb[vb]=bb(tb[vb],ub[vb]);}else if(ub[vb]&&typeof ub[vb]==='object'){var wb={};ha(wb,ub[vb]);tb[vb]=wb;}return tb;}function bb(tb,ub){var vb=tb.offset<ub.offset?tb.offset:ub.offset,wb=tb.offset+tb.limit,xb=ub.offset+ub.limit,yb=(wb>xb)?wb:xb,zb=yb-vb;return {offset:vb,limit:zb};}function cb(tb,ub){var vb=tb.client||ub.client,wb={ids:{},client:vb};ha(wb.ids,tb.ids);ha(wb.ids,ub.ids);return wb;}function db(tb,ub){var vb={},wb,xb=tb.client||ub.client;delete tb.client;delete ub.client;for(wb in tb)ha(vb,ia(tb[wb],wb));for(wb in ub)ha(vb,ia(ub[wb],wb));var yb={client:xb};for(var zb in vb){wb=vb[zb];if(!yb[wb])yb[wb]=[];yb[wb].push(zb);}return yb;}function eb(tb,ub){var vb=tb.client||ub.client,wb=ia(tb.ids,true),xb=ia(ub.ids,true),yb=ha(wb,xb);return {ids:Object.keys(yb),client:vb};}function fb(tb){this._fbid=tb;this._lastActionId=0;this._serverToClientIDs=new l();this._clientToServerIDs=new l();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};rb(this);}ha(fb.prototype,g,{tokenizeThreadID:function(tb){p.isThreadID(tb);return t.tokenize(tb);},getServerThreadID:function(tb,ub){p.isThreadID(tb);oa(this,tb,ub);},getClientThreadID:function(tb,ub){sa(this,tb,ub);},getClientThreadIDNow:function(tb){return ra(this,tb);},getServerThreadIDNow:function(tb){return pa(this,tb);},convertThreadIDIfAvailable:function(tb){var ub=this._serverToClientIDs.getResource(tb);if(ub===undefined){return tb;}else return ub;},canLinkExternally:function(tb){p.isThreadID(tb);var ub=this.tokenizeThreadID(tb);return (ub.type=='user')||!!pa(this,tb);},fetchThreadlistInfo:function(tb,ub,vb,wb,xb){vb=vb||da.INBOX;xb=xb||ka;var yb=wb?fa.IMMEDIATE:null,zb={client:xb};zb[vb]={offset:tb,limit:ub,filter:wb};sb(this,'/ajax/mercury/threadlist_info.php',zb,yb);},fetchUnseenThreadIDs:function(tb,ub){ub=ub||ka;this.fetchThreadlistInfo(z.RECENT_THREAD_OFFSET,z.JEWEL_THREAD_COUNT,tb,null,ub);},fetchUnreadThreadIDs:function(tb,ub){ub=ub||ka;sb(this,'/ajax/mercury/unread_threads.php',{folders:[tb],client:ub});},fetchMissedMessages:function(tb,ub){ub=ub||ka;sb(this,'/ajax/mercury/thread_sync.php',{last_action_id:this._lastActionId,folders:tb,client:ub});},fetchThreadData:function(tb,ub){ub=ub||ka;p.allThreadID(tb);var vb={threads:{},client:ub},wb=[],xb=[];tb.forEach(function(zb){if(this._fetchingThreads[zb])return;this._fetchingThreads[zb]=true;var ac=pa(this,zb);if(ac){xb.push(ac);vb.threads.thread_ids=xb;}else{var bc=this.tokenizeThreadID(zb);if(bc.type=='user'){wb.push(bc.value);vb.threads.user_ids=wb;}else if(bc.type=='thread'){xb.push(bc.value);vb.threads.thread_ids=xb;}else if(bc.type!='root'&&bc.type!='pending')throw new Error('Unknown thread type',bc);}}.bind(this));this.inform("fetch-thread-data",vb);for(var yb in vb.threads){sb(this,'/ajax/mercury/thread_info.php',vb);break;}},ensureThreadIsFetched:function(tb,ub){ub=ub||ka;if(!this._serverToClientIDs.getResource(tb)&&!this._fetchingThreads[tb]){this._fetchingThreads[tb]=true;sb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[tb]},client:ub});}},fetchThreadMessages:function(tb,ub,vb,wb,xb){p.isThreadID(tb);xb=xb||ka;var yb,zb,ac=this.tokenizeThreadID(tb),bc=pa(this,tb),cc=false;if(bc&&ac.type!='group'){zb='thread_ids';yb=bc;}else{yb=ac.value;switch(ac.type){case 'user':zb='user_ids';cc=true;break;case 'group':zb='group_ids';break;case 'thread':zb='thread_ids';break;}}var dc={messages:{},threads:{},client:xb};if(zb){dc.messages[zb]={};dc.messages[zb][yb]={offset:ub,limit:vb};if(cc)dc.threads[zb]=[yb];sb(this,'/ajax/mercury/thread_info.php',dc,wb);}else oa(this,tb,function(ec){dc.messages.thread_ids={};dc.messages.thread_ids[ec]={offset:ub,limit:vb};sb(this,'/ajax/mercury/thread_info.php',dc,wb);}.bind(this));},handleThreadInfoError:function(tb){var ub=tb.getRequest().getData(),vb=[];if(ub.messages){for(var wb in ub.messages.thread_ids)vb.push(gb(ra(this,wb)));for(var xb in ub.messages.user_ids)vb.push(gb('user:'+xb));for(var yb in ub.messages.group_ids)vb.push(gb('group:'+yb));}if(vb.length)this.handleUpdate({actions:vb,from_client:true,payload_source:w.CLIENT_CHANNEL_MESSAGE});if(ub.threads&&(ub.threads.user_ids||ub.threads.group_ids||ub.threads.thread_ids)){var zb=5,ac=true;if(!ub.retry_count){ub.retry_count=0;if(ub.messages)delete ub.messages;}else if(ub.retry_count>=zb){ac=false;(ub.threads.thread_ids||[]).forEach(function(cc){if(cc in this._fetchingThreads)delete this._fetchingThreads[cc];}.bind(this));}if(ac){var bc=ub.retry_count*1000;(function(){ja.log('retry_thread',ub);sb(this,'/ajax/mercury/thread_info.php',ub);}.bind(this)).defer(bc,false);ub.retry_count++;}}},markFolderAsRead:function(tb){sb(this,'/ajax/mercury/mark_folder_as_read.php',{folder:tb});var ub=[{action_type:s.MARK_ALL_READ,action_id:null,folder:tb}];this.handleUpdate({global_actions:ub,from_client:true,payload_source:w.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(tb,ub,vb){p.isThreadID(tb);oa(this,tb,function(xb){var yb={ids:{}};yb.ids[xb]=ub;sb(this,'/ajax/mercury/change_read_status.php',yb);}.bind(this));var wb=[{action_type:m.CHANGE_READ_STATUS,action_id:null,thread_id:tb,mark_as_read:ub,folder:vb}];this.handleUpdate({actions:wb,from_client:true,payload_source:w.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(tb,ub){p.isThreadID(tb);oa(this,tb,function(xb){var yb={ids:{}};yb.ids[xb]=ub;sb(this,'/ajax/mercury/change_archived_status.php',yb);}.bind(this));var vb={action_type:m.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:tb,archived:ub},wb={actions:[vb],from_client:true,payload_source:w.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(wb);},changeThreadFolder:function(tb,ub){p.isThreadID(tb);oa(this,tb,function(xb){var yb={};yb[ub]=[xb];sb(this,'/ajax/mercury/move_thread.php',yb);}.bind(this));var vb={action_type:m.CHANGE_FOLDER,action_id:null,thread_id:tb,new_folder:ub},wb={actions:[vb],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(wb);},changeMutingOnThread:function(tb,ub){p.isThreadID(tb);oa(this,tb,function(xb){sb(this,'/ajax/mercury/change_mute_thread.php',{thread_id:xb,mute_settings:ub,payload_source:ka});}.bind(this));var vb={action_type:m.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:tb,mute_settings:ub},wb={actions:[vb],from_client:true,payload_source:w.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(wb);},markThreadSpam:function(tb){p.isThreadID(tb);oa(this,tb,function(wb){sb(this,'/ajax/mercury/mark_spam.php',{id:wb});}.bind(this));var ub={action_type:m.CHANGE_FOLDER,action_id:null,thread_id:tb,new_folder:da.SPAM},vb={actions:[ub],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(vb);},markMessagesSpam:function(tb,ub){aa.getServerIDs(ub||[],function(wb){sb(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:wb});}.bind(this));var vb={action_type:m.DELETE_MESSAGES,action_id:null,thread_id:tb,message_ids:ub};this.handleUpdate({actions:[vb],from_client:true,payload_source:w.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(tb){p.isThreadID(tb);oa(this,tb,function(wb){sb(this,'/ajax/mercury/unmark_spam.php',{id:wb});}.bind(this));var ub={action_type:m.CHANGE_FOLDER,action_id:null,thread_id:tb,new_folder:da.INBOX},vb={actions:[ub],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(vb);},deleteThread:function(tb){p.isThreadID(tb);oa(this,tb,function(wb){var xb={ids:[wb]};sb(this,'/ajax/mercury/delete_thread.php',xb);}.bind(this));var ub={action_type:m.DELETE_THREAD,action_id:null,thread_id:tb},vb={actions:[ub],from_client:true,payload_source:w.CLIENT_DELETE_THREAD};this.handleUpdate(vb);},deleteMessages:function(tb,ub,vb){aa.getServerIDs(ub||[],function(xb){sb(this,'/ajax/mercury/delete_messages.php',{message_ids:xb});}.bind(this));var wb;if(vb){wb={action_type:m.DELETE_THREAD,action_id:null,thread_id:tb};}else wb={action_type:m.DELETE_MESSAGES,action_id:null,thread_id:tb,message_ids:ub};this.handleUpdate({actions:[wb],from_client:true,payload_source:w.CLIENT_DELETE_MESSAGES});},clearChat:function(tb,ub,vb){p.isThreadID(tb);sb(this,'/ajax/chat/settings.php',{clear_history_id:ub});var wb=[{action_type:m.CLEAR_CHAT,action_id:null,thread_id:tb,clear_time:vb}];this.handleUpdate({actions:wb,from_client:true,payload_source:w.CLIENT_CLEAR_CHAT});},sendNewMessage:function(tb,ub){ub=ub||ka;if(!tb.client_state||tb.client_state==v.SEND_TO_SERVER)aa.getServerIDs(tb.forward_message_ids||[],function(wb){var xb=tb.thread_id,yb=this.tokenizeThreadID(tb.thread_id),zb=yb.type,ac=ha({},tb);ac.forward_message_ids=wb;if((zb=='root'&&yb.value==ac.message_id)||(zb=='user'&&!pa(this,xb))||(tb.thread_id==r.PENDING_THREAD_ID)){ac.client_thread_id=ac.thread_id;ac.thread_id=null;this._sendNewMessageToServer(ac,ub);}else oa(this,ac.thread_id,function(bc){ac.thread_id=bc;this._sendNewMessageToServer(ac);}.bind(this));}.bind(this));if(tb.thread_id!=r.PENDING_THREAD_ID){var vb={actions:[ha({},tb)],from_client:true,payload_source:w.CLIENT_SEND_MESSAGE};this.handleUpdate(vb);}},_sendNewMessageToServer:function(tb,ub){ub=ub||ka;sb(this,'/ajax/mercury/send_messages.php',{message_batch:[tb],client:ub});},requestMessageConfirmation:function(tb,ub){ub=ub||ka;var vb={},wb={};for(var xb in tb){var yb=pa(this,xb);if(yb){vb[yb]=tb[xb];}else{var zb=tb[xb];for(var ac=0;ac<zb.length;ac++)wb[zb[ac]]=xb;}}var bc=Object.keys(vb),cc=Object.keys(wb);if(bc.length||cc.length)sb(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:vb,local_messages:wb,client:ub});},handleMessageConfirmError:function(tb){var ub=tb.getRequest().getData().thread_message_map,vb=tb.getRequest().getData().local_messages;if(!ub&&!vb)return;var wb=[];for(var xb in ub){var yb=ub[xb];yb.forEach(function(bc){wb.push({action_type:m.SEND_MESSAGE,client_message_id:bc,message_id:bc,client_thread_id:null,thread_id:xb,status:n.UNABLE_TO_CONFIRM});});}for(var zb in vb){var ac=vb[zb];wb.push({action_type:m.SEND_MESSAGE,client_message_id:zb,message_id:zb,client_thread_id:ac,thread_id:null,status:n.UNABLE_TO_CONFIRM});}if(wb.length)this.handleUpdate({actions:wb,payload_source:w.CLIENT_HANDLE_ERROR});},markSeen:function(){var tb=i.convertActionIDToTimestamp(this._lastActionId);sb(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:tb});},handleRoger:function(tb){var ub=tb.tid?this._serverToClientIDs.getResource(tb.tid):('user:'+tb.reader);if(ub){var vb={};vb[ub]={};vb[ub]['fbid:'+tb.reader]=tb.time;this.inform('update-roger',vb);}},handleUpdateWaitForThread:function(tb,ub,vb){vb=vb||ka;var wb=this._serverToClientIDs.getResource(ub);if(wb){this.handleUpdate(tb);return;}this._serverToClientIDs.executeOrEnqueue(ub,function(){this._pendingUpdates.push(tb);}.bind(this));if(!this._fetchingThreads[ub]){this._fetchingThreads[ub]=true;sb(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[ub]},client:vb});}},handleUpdate:function(tb){var ub=[];if(tb&&tb.threads)for(var vb=0;vb<tb.threads.length;vb++){if(!tb.threads[vb].snippet_attachments)continue;for(var wb=0;wb<tb.threads[vb].snippet_attachments.length;wb++)if(tb.threads[vb].snippet_attachments[wb].share_xhp){ub.push({i:vb,j:wb,xhp:tb.threads[vb].snippet_attachments[wb].share_xhp});tb.threads[vb].snippet_attachments[wb].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}ja.debug('handle_update',{payload:tb,from_client:tb.from_client});for(var xb=0;xb<ub.length;xb++)tb.threads[ub[xb].i].snippet_attachments[ub[xb].j].share_xhp=ub[xb].xhp;for(xb in tb){ga.getForFBID(this._fbid).synchronizeInforms(function(){if(!tb.from_client){wa(this,tb);this.inform('payload-preprocessed',tb);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',tb);this.inform('update-threads',tb);this.inform('update-unread',tb);this.inform('update-threadlist',tb);this.inform('update-messages',tb);this.inform('update-unseen',tb);this.inform('update-typing-state',tb);this.inform('update-roger',tb.roger);this.inform('model-update-completed',null);xa(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(tb,ub,vb,wb){ja.debug('handle_send_message_error_common',{reliability_error_status:vb,request_error_status:ub});var xb=tb.getData(),yb=xb.message_batch,zb=yb.map(function(bc){return {action_type:m.SEND_MESSAGE,client_message_id:bc.message_id,message_id:bc.message_id,client_thread_id:bc.client_thread_id,thread_id:bc.thread_id,status:ub,error_data:wb};});zb.forEach(function(bc){ta(this,bc,vb);}.bind(this));var ac={actions:zb,payload_source:w.CLIENT_HANDLE_ERROR};this.handleUpdate(ac);},handleSendMessageError:function(tb){var ub=tb.getPayload(),vb=null,wb=null;if(ub&&ub.error_payload){vb=n.UNCONFIRMED;wb='send_error';}else{vb=n.ERROR;wb='request_error'+ua(tb);}var xb=tb.error;if(xb===1404102)h.verboseErrorHandler(tb);var yb=/<.*>/.test(tb.getErrorDescription())?tb.getErrorSummary():tb.getErrorDescription();this._handleSendMessageErrorCommon(tb.getRequest(),vb,wb,{type:q.SERVER,code:tb.getError(),description:yb,is_transient:tb.isTransient()});},handleSendMessageTransportError:function(tb){this._handleSendMessageErrorCommon(tb.getRequest(),n.ERROR,'transport_error'+ua(tb),{type:q.TRANSPORT,code:tb.getError(),is_transient:true});},handleSendMessageTimeout:function(tb){this._handleSendMessageErrorCommon(tb,n.ERROR,'transport_timeout',{type:q.TIMEOUT,is_transient:true});},getLastActionID:function(){return this._lastActionId;}});ha(fb,ea);function gb(tb){return {action_type:m.LOG_MESSAGE,thread_id:tb,message_id:tb,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:y.UNKNOWN,log_message_type:u.SERVER_ERROR,log_message_data:{}};}function hb(tb){var ub=tb.getData(),vb=ub.request_user_id?ub.request_user_id:j.user;return fb.getForFBID(vb);}function ib(tb,ub){hb(ub).handleUpdate(tb);}function jb(tb,ub){var vb=tb.client||ub.client;return {client:vb,message_batch:tb.message_batch.concat(ub.message_batch)};}function kb(tb,ub){var vb={};ha(vb,tb.ids);ha(vb,ub.ids);var wb=tb.client||ub.client;return {ids:vb,client:wb};}function lb(tb,ub){return ub;}function mb(tb){var ub=hb(tb.getRequest());ub.handleThreadInfoError(tb);}function nb(tb){var ub=hb(tb.getRequest());ub.handleSendMessageError(tb);}function ob(tb){var ub=hb(tb.getRequest());ub.handleSendMessageTransportError(tb);}function pb(tb){var ub=hb(tb);ub.handleSendMessageTimeout(tb);}function qb(tb){var ub=hb(tb.getRequest());ub.handleMessageConfirmError(tb);}function rb(tb){fa.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:tb._fbid,mode:fa.IDEMPOTENT,handler:ib},'/ajax/mercury/thread_info.php':{request_user_id:tb._fbid,mode:fa.BATCH_DEFERRED_MULTI,batch_function:ya,handler:ib,error_handler:mb},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib},'/ajax/mercury/change_read_status.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:kb,handler:ib},'/ajax/mercury/send_messages.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:jb,batch_size_limit:ba.SEND_BATCH_LIMIT,handler:ib,error_handler:nb,transport_error_handler:ob,timeout:x.sendMessageTimeout,timeout_handler:pb,connection_retries:ba.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:lb,handler:ib},'/ajax/mercury/confirm_messages.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib,error_handler:qb},'/ajax/mercury/threadlist_info.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE_UNIQUE,batch_function:ab,handler:ib},'/ajax/mercury/mark_spam.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib},'/ajax/mercury/mark_spam_messages.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib},'/ajax/mercury/unmark_spam.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib},'/ajax/mercury/unread_threads.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE_UNIQUE,batch_function:za,handler:ib},'/ajax/chat/settings.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:cb,handler:ib},'/ajax/mercury/delete_thread.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:eb,handler:ib},'/ajax/mercury/delete_messages.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib},'/ajax/mercury/move_thread.php':{request_user_id:tb._fbid,mode:fa.BATCH_SUCCESSIVE,batch_function:db,handler:ib},'/ajax/mercury/change_mute_thread.php':{request_user_id:tb._fbid,mode:fa.IMMEDIATE,handler:ib}});}function sb(tb,ub,vb,wb){fa.trySend(ub,vb,wb,tb._fbid);}e.exports=fb;});
__d("MercuryParticipants",["Env","ImageSourceRequest","ImageSourceType","MercuryAssert","MercuryIDs","MercuryParticipantTypes","MercuryParticipantsConstants","PhotoResizeModeConst","MercuryServerRequests","ShortProfiles","copyProperties","getObjectValues","tx"],function(a,b,c,d,e,f){var g=b('Env'),h=b('ImageSourceRequest'),i=b('ImageSourceType'),j=b('MercuryAssert'),k=b('MercuryIDs'),l=b('MercuryParticipantTypes'),m=b('MercuryParticipantsConstants'),n=b('PhotoResizeModeConst'),o=b('MercuryServerRequests').get(),p=b('ShortProfiles'),q=b('copyProperties'),r=b('getObjectValues'),s=b('tx'),t='fbid:'+g.user,u={},v={},w=function(ba){ba=z(ba);if(u[ba.id]){q(u[ba.id],ba);}else u[ba.id]=q({},ba);if(ba.vanity)v[ba.vanity]=ba.id;};function x(ba){j.isEmailParticipantID(ba);var ca=k.tokenize(ba),da=ca.value;return {gender:m.UNKNOWN_GENDER,href:null,id:ba,image_src:m.EMAIL_IMAGE,big_image_src:m.EMAIL_IMAGE,name:da,short_name:da,employee:false,call_promo:false};}function y(ba,ca,da){j.allParticipantIDs(ba);var ea={},fa={};ba.forEach(function(ha){if(u[ha]&&!da){ea[ha]=q({},u[ha]);}else{var ia=k.tokenize(ha);if(ia.type=='fbid'){var ja=ia.value;fa[ha]=ja;}else if(ia.type=='email')ea[ha]=x(ha);}});var ga=r(fa);if(ga.length){p.getMulti(ga,function(ha){for(var ia in fa){var ja=fa[ia],ka=ha[ja];ea[ia]={gender:ka.gender,href:ka.uri,id:ia,image_src:ka.thumbSrc,name:ka.name,short_name:ka.firstName,employee:ka.employee,call_promo:ka.showVideoPromo,type:ka.type,vanity:ka.vanity,is_friend:ka.is_friend,social_snippets:ka.social_snippets};w(ea[ia]);}ca(ea);});}else ca(ea);}function z(ba){var ca=ba.type===l.USER||ba.type===l.FRIEND;if(!ca)return ba;if(!ba.name&&!ba.href&&!ba.vanity){var da="Facebook User";ba.name=da;ba.short_name=da;}return ba;}var aa={user:t,isAuthor:function(ba){return ba===t;},getIDFromVanityOrFBID:function(ba){if(!ba)return;if(v[ba])return v[ba];if(ba.match('^\\d+$'))return aa.getIDForUser(ba);},getNow:function(ba){return u[ba];},get:function(ba,ca){j.isParticipantID(ba);aa.getMulti([ba],function(da){ca(da[ba]);});},getMulti:function(ba,ca,da){return y(ba,ca,false);},getBigImageMulti:function(ba,ca){j.allParticipantIDs(ba);var da=m.BIG_IMAGE_SIZE;aa.getMulti(ba,function(ea){var fa={},ga=0,ha=function(la,ma){ga++;fa[la]=ma;if(ga===ba.length)ca(fa);},ia=function(la,ma){u[la].big_image_src=ma.uri;ha(la,ma.uri);};for(var ja in ea){var ka=ea[ja];if(!ka.big_image_src){new h().setFBID(aa.getUserID(ja)).setType(i.PROFILE_PICTURE).setDimensions(da,da).setResizeMode(n.COVER).setCallback(ia.curry(ja)).send();}else ha(ka.id,ka.big_image_src);}});},getOrderedBigImageMulti:function(ba,ca){aa.getBigImageMulti(ba,function(da){var ea=ba.map(function(fa){return da[fa];});ca(ea);});},getMultiForceDownload:function(ba,ca){return y(ba,ca,true);},getUserID:function(ba){return k.getUserIDFromParticipantID(ba);},getIDForUser:function(ba){return 'fbid:'+ba;},addParticipants:function(ba){ba.forEach(w);}};o.subscribe('update-participants',function(ba,ca){aa.addParticipants(ca.participants||[]);});e.exports=aa;});
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f){var g=b('MessagingTag'),h=b('arrayContains'),i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;});
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f){var g=b('MercuryAttachmentContentType'),h=b('MercuryAttachmentType'),i=b('startsWith'),j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';if(o==g.PHOTO)p.preview_loading=true;l.push(p);}}return l;},get:function(k){if(k.attachments){return k.attachments;}else if(k.raw_attachments){return this.convertRaw(k.raw_attachments);}else return [];}};e.exports=j;});
__d("MercuryThreads",["Arbiter","TimestampConverter","MercuryFolders","JSLogger","KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('TimestampConverter'),i=b('MercuryFolders'),j=b('JSLogger'),k=b('KeyedCallbackManager'),l=b('MercuryActionTypeConstants'),m=b('MercuryAssert'),n=b('MercuryAttachment'),o=b('MercuryGlobalActionType'),p=b('MercuryIDs'),q=b('MercuryLogMessageType'),r=b('MercurySingletonMixin'),s=b('MercuryThreadMode'),t=b('MessagingTag'),u=b('MercuryParticipants'),v=b('MercuryServerRequests'),w=b('MercuryThreadInformer'),x=b('copyProperties'),y=b('createObjectFrom'),z=b('removeFromArray'),aa=j.create('mercury_threads');function ba(na,oa,pa){var qa=y(oa.participants,true),ra=u.getIDForUser(na._fbid);pa.forEach(function(sa){if(qa[sa]!==true){oa.participants.push(sa);if(sa===ra)oa.is_subscribed=true;}});}function ca(na,oa,pa){z(oa.participants,pa);if(pa===u.getIDForUser(na._fbid))oa.is_subscribed=false;}function da(na,oa){if(na.participants[0]!=oa){z(na.participants,oa);na.participants.unshift(oa);}}function ea(na,oa){var pa=oa.body,qa=oa.subject,ra='';if(qa){qa=qa.toLowerCase();if(pa.slice(0,qa.length).toLowerCase()==qa){ra=pa;}else if(pa){ra=qa+' \u00B7 '+pa;}else ra=qa;}else ra=pa;na.snippet=ra;na.snippet_has_attachment=oa.has_attachment;if(oa.raw_attachments&&oa.raw_attachments.length>0){var sa=n.convertRaw(oa.raw_attachments);na.snippet_attachments=sa;}else na.snippet_attachments=oa.attachments;na.is_forwarded_snippet=!!oa.forward_count;na.snippet_sender=oa.author;}function fa(na,oa,pa){if(!oa)return false;if(!oa.timestamp)return true;var qa=!oa.unread_count;if(pa==qa)return false;oa.unread_count=pa?0:1;na._threadInformer.updatedThread(oa.thread_id);return true;}function ga(na,oa){var pa=na._threads.getAllResources();for(var qa in pa){var ra=pa[qa];if(ra.folder==oa){ra.unread_count=0;na._threads.setResource(qa,ra);na._threadInformer.updatedThread(qa);}}}function ha(na,oa,pa){if(!oa||oa.chat_clear_time===pa)return false;oa.chat_clear_time=pa;na._threadInformer.reorderedMessages(oa.thread_id);return true;}function ia(na,oa,pa,qa){var ra=pa.action_type;if(ra==l.USER_GENERATED_MESSAGE||ra==l.LOG_MESSAGE){pa.is_unread&&oa.unread_count++;oa.message_count++;oa.is_archived=false;}switch(ra){case l.USER_GENERATED_MESSAGE:da(oa,pa.author);break;case l.SEND_MESSAGE:var sa=pa.log_message_type;if(sa==q.THREAD_IMAGE)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;oa.snippet_attachments=pa.attachments;break;case l.LOG_MESSAGE:var sa=pa.log_message_type;if(sa==q.SUBSCRIBE){ba(na,oa,pa.log_message_data.added_participants);}else if(sa==q.JOINABLE_JOINED){ba(na,oa,[pa.log_message_data.joined_participant]);}else if(sa==q.UNSUBSCRIBE){ca(na,oa,pa.author);}else if(sa==q.THREAD_IMAGE){if(!qa)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;}else if(sa==q.THREAD_NAME)oa.name=pa.log_message_data.name;break;case l.CHANGE_READ_STATUS:if(pa.timestamp)na._threadInformer.changedThreadReadState(oa.thread_id,pa.mark_as_read,pa.timestamp);fa(na,oa,pa.mark_as_read);break;case l.CLEAR_CHAT:ha(na,oa,pa.clear_time);break;case l.CHANGE_ARCHIVED_STATUS:oa.is_archived=pa.archived;break;case l.CHANGE_FOLDER:oa.folder=pa.new_folder;break;case l.DELETE_MESSAGES:if(qa){oa.snippet='...';oa.snippet_has_attachment=false;oa.snippet_attachments=null;oa.snippet_sender=null;oa.is_forwarded_snippet=false;na._threadInformer.updatedThread(pa.thread_id);}else if(pa.message_ids)oa.message_count=oa.message_count-pa.message_ids.length;break;case l.CHANGE_MUTE_SETTINGS:if(pa.mute_settings!==undefined){var ta=na._fbid+'@facebook.com';if(oa.mute_settings){if(pa.mute_settings){oa.mute_settings[ta]=pa.mute_settings;}else delete oa.mute_settings[ta];na._threadInformer.updatedThread(oa.thread_id);}}break;}if(pa.action_id)oa.last_action_id=h.maxValidActionID(pa.action_id,oa.last_action_id);}function ja(na,oa){var pa=na._serverRequests.tokenizeThreadID(oa.thread_id);if(pa.type=='group'){aa.error('invalid_new_thread_message',oa);return undefined;}var qa=la(na,oa.specific_to_list),ra={thread_id:oa.thread_id,last_action_id:oa.action_id,participants:oa.specific_to_list,name:null,snippet:oa.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:oa.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:oa.timestamp_absolute,timestamp_relative:oa.timestamp_relative,timestamp:oa.timestamp,canonical_fbid:pa.type==='user'?pa.value:null,is_canonical_user:pa.type==='user',is_canonical:qa,is_subscribed:true,root_message_threading_id:oa.message_id,folder:t.INBOX,is_archived:false,mode:s.TITAN_ORIGINATED};return ra;}function ka(na){this._fbid=na;this._serverRequests=v.getForFBID(this._fbid);this._threadInformer=w.getForFBID(this._fbid);this._threads=new k();ma(this);}x(ka.prototype,{getThreadMetaNow:function(na){m.isThreadID(na);return this._threads.getResource(na);},getThreadMeta:function(na,oa,pa){var qa=function(ra){oa(ra[na]);};return this.getMultiThreadMeta([na],qa,pa);},getMultiThreadMeta:function(na,oa,pa){m.allThreadID(na);var qa=this._threads.executeOrEnqueue(na,oa),ra=this._threads.getUnavailableResources(qa);if(ra.length){var sa=[];for(var ta=0;ta<ra.length;ta++){var ua=ra[ta],va=this._serverRequests.tokenizeThreadID(ua);if(va.type=='user'){var wa=this.getCanonicalThreadToUser(va.value,null,pa,true);if(this.isEmptyLocalThread(wa.thread_id))sa.push(wa.thread_id);}else sa.push(ua);}if(sa.length)this._serverRequests.fetchThreadData(sa,pa);}return qa;},unsubscribe:function(na){this._threads.unsubscribe(na);},changeThreadReadStatus:function(na,oa){m.isThreadID(na);var pa=this._threads.getResource(na);if(fa(this,pa,oa))this._serverRequests.changeThreadReadStatus(na,oa,i.getFromMeta(pa));},changeThreadArchivedStatus:function(na,oa){m.isThreadID(na);var pa=this._threads.getResource(na);if(pa.is_archived!=oa){pa.is_archived=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadArchivedStatus(na,oa);}},markThreadSpam:function(na){this._serverRequests.markThreadSpam(na);},unmarkThreadSpam:function(na){this._serverRequests.unmarkThreadSpam(na);},updateThreadMuteSetting:function(na,oa){this._serverRequests.changeMutingOnThread(na,oa);},changeFolder:function(na,oa){m.isThreadID(na);var pa=this._threads.getResource(na);if(pa&&pa.folder!=oa){pa.folder=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadFolder(na,oa);}},deleteThread:function(na){m.isThreadID(na);this._serverRequests.deleteThread(na);},updateThreads:function(na){if(!na||!na.length)return;var oa={};na.forEach(function(pa){oa[pa.thread_id]=pa;});this._threads.addResourcesAndExecute(oa);},updateMetadataByActions:function(na,oa){if(!na||!na.length)return;var pa={},qa={},ra={};for(var sa=0;sa<na.length;sa++){var ta=na[sa];if(ta.is_forward)continue;var ua=ta.action_type,va=ta.thread_id;m.isThreadID(va);var wa=this.getThreadMetaNow(va);if(ua==l.LOG_MESSAGE&&ta.log_message_type==q.SERVER_ERROR)continue;if(!wa&&!ta.action_id&&ua==l.USER_GENERATED_MESSAGE){wa=ja(this,ta);this._threads.setResource(va,wa);}if(wa){if(ua==l.DELETE_THREAD){wa.message_count=0;this._threadInformer.deletedThread(va);continue;}var xa=!!ta.action_id;if(ua==l.LOG_MESSAGE||ua==l.USER_GENERATED_MESSAGE)xa=!oa;if(wa.server_timestamp&&ta.timestamp<=wa.server_timestamp&&xa)continue;if(!ra[va])ra[va]=x({},wa);ia(this,ra[va],ta,oa);if(ua==l.USER_GENERATED_MESSAGE)pa[va]=ta;if(ua==l.USER_GENERATED_MESSAGE||ua==l.LOG_MESSAGE||ua==l.SEND_MESSAGE)if(ta&&ta.timestamp&&(!qa[va]||ta.timestamp>qa[va].timestamp))qa[va]=ta;}}for(var ya in ra){var za=ra[ya],ab=pa[ya];if(ab)ea(za,ab);var bb=qa[ya],cb=za.timestamp;if(bb){if(bb.timestamp>cb)za=x(za,{timestamp_absolute:bb.timestamp_absolute,timestamp_relative:bb.timestamp_relative,timestamp:bb.timestamp});var db=za.server_timestamp;if(!oa&&bb.timestamp>db)za.server_timestamp=bb.timestamp;}this._threads.setResource(ya,za);}},getCanonicalThreadToUser:function(na,oa,pa,qa){return this.getCanonicalThreadToParticipant('fbid:'+na,oa,pa,qa);},getCanonicalThreadToParticipant:function(na,oa,pa,qa){var ra=this.getThreadIDForParticipant(na),sa=this._threads.getResource(ra);if(typeof sa=='undefined'){sa=this.createNewLocalThread(ra,[u.getIDForUser(this._fbid),na],oa);!qa&&this._serverRequests.fetchThreadData([ra],pa);}return sa;},getThreadIdForUser:function(na){return 'user:'+na;},getThreadIDForParticipant:function(na){var oa=p.tokenize(na);return this.getThreadIdForUser(oa.value);},createNewLocalThread:function(na,oa,pa){var qa=this._threads.getResource(na);if(!qa){var ra=this._serverRequests.tokenizeThreadID(na);qa={thread_id:na,last_action_id:null,participants:oa,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:pa?pa:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ra.type==='user'?ra.value:null,is_canonical_user:ra.type=='user',is_canonical:la(this,oa),is_subscribed:true,root_message_threading_id:null,folder:t.INBOX,is_archived:false,mode:s.TITAN_ORIGINATED};this._threads.setResource(na,qa);}return qa;},addParticipantsToThreadLocally:function(na,oa){var pa=this._threads.getResource(na);if(pa){ba(this,pa,oa);this._threadInformer.updatedThread(pa.thread_id);}},getCanonicalUserInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='user'?oa.value:null;},getCanonicalGroupInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='group'?oa.value:null;},isEmptyLocalThread:function(na){var oa=this._threads.getResource(na);if(!oa)return false;var pa=this._serverRequests.tokenizeThreadID(na);return pa.type=='root'&&!oa.timestamp;},isNewEmptyLocalThread:function(na){if(!this.isEmptyLocalThread(na))return false;var oa=this._threads.getResource(na);return oa.participants&&oa.participants.length===0;},canReply:function(na){var oa=this._threads.getResource(na);return oa&&oa.is_subscribed&&oa.mode!=s.OBJECT_ORIGINATED&&(oa.recipients_loadable||oa.recipients_loadable===undefined);}});x(ka,r);function la(na,oa){var pa=oa.filter(function(qa){return qa!=u.getIDForUser(na._fbid);});return pa.length<=1;}function ma(na){na._serverRequests.subscribe('update-threads',function(oa,pa){var qa=(pa.actions||[]).filter(function(ua){return ua.thread_id;});na.updateThreads(pa.threads);na.updateMetadataByActions(qa,pa.from_client);(pa.threads||[]).forEach(function(ua){na._threadInformer.updatedThread(ua.thread_id);});var ra=pa.global_actions||[];for(var sa=0;sa<ra.length;sa++){var ta=ra[sa];if(ta.action_type==o.MARK_ALL_READ)ga(na,ta.folder);}});}g.subscribe(j.DUMP_EVENT,function(na,oa){oa.messaging=oa.messaging||{};oa.messaging.threads={};var pa=ka._getInstances();for(var qa in pa)oa.messaging.threads[qa]=pa[qa]._threads.dumpResources();});e.exports=ka;});
__d("MercuryUnreadState",["Arbiter","MercuryFolders","JSLogger","KeyedCallbackManager","MercuryActionTypeConstants","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryFolders'),i=b('JSLogger'),j=b('KeyedCallbackManager'),k=b('MercuryActionTypeConstants'),l=b('MercuryGlobalActionType'),m=b('MercurySingletonMixin'),n=b('MercuryThreadlistConstants'),o=b('MessagingTag'),p=b('MercuryServerRequests'),q=b('MercuryThreadInformer'),r=b('MercuryThreads'),s=b('arrayContains'),t=b('copyProperties'),u=b('createObjectFrom'),v=(h.getSupportedFolders()||[]).filter(function(ma){return ma!=o.ACTION_ARCHIVED;}),w='unread_thread_hash',x='unseen_thread_list',y=n.MAX_UNREAD_COUNT,z=i.create('mercury_unread_state');function aa(ma){this._fbid=ma;this._serverRequests=p.getForFBID(this._fbid);this._threadInformer=q.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};v.forEach(function(na){this._initialUnreadCount[na]=0;this._maxCount[na]=false;this._unreadResources[na]=new j();}.bind(this));this._serverRequests.subscribe('update-unread',function(na,oa){fa(this,oa);var pa=oa.global_actions||[];for(var qa=0;qa<pa.length;qa++){var ra=pa[qa];if(ra.action_type==l.MARK_ALL_READ)ia(this,ra.folder,ra.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(na,oa){ka(this,oa);}.bind(this));}t(aa.prototype,{getUnreadCount:function(ma){if(this.exceedsMaxCount(ma)){z.error('unguarded_unread_count_fetch',{});return 0;}return ea(this,ma);},exceedsMaxCount:function(ma){return this._maxCount[ma]||(ea(this,ma)>y);},markFolderAsRead:function(ma){if(this._maxCount[ma]||ea(this,ma)>0)this._serverRequests.markFolderAsRead(ma);}});t(aa,m);function ba(ma,na,oa){ma._unreadResources[na].setResource(w,oa);ma._unreadResources[na].setResource(x,Object.keys(oa));}function ca(ma,na,oa){var pa=ma._unreadResources[na].executeOrEnqueue(w,oa),qa=ma._unreadResources[na].getUnavailableResources(pa);if(qa.length)ma._serverRequests.fetchUnreadThreadIDs(na);}function da(ma,na){return ma._unreadResources[na].getResource(w);}function ea(ma,na){var oa=ma._unreadResources[na].getResource(x);if(oa){return oa.length;}else return ma._initialUnreadCount[na];}function fa(ma,na){var oa;(na.unread_thread_ids||[]).forEach(function(pa){oa=pa.folder;if(!la(oa))return;var qa=ja(ma,pa.thread_ids);ba(ma,oa,u(qa,true));if(qa.length>y)ma._maxCount[oa]=true;ma._threadInformer.updatedUnreadState();});(na.message_counts||[]).forEach(function(pa){if(pa.unread_count===undefined)return;oa=pa.folder;if(pa.unread_count>y){ma._maxCount[oa]=true;ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}else{ma._initialUnreadCount[oa]=pa.unread_count;if(ma._initialUnreadCount[oa]===0)ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}});(na.actions||[]).forEach(function(pa){if(pa.is_forward)return;var qa=k,ra=pa.thread_id?pa.thread_id:pa.server_thread_id;if(pa.action_type==qa.DELETE_THREAD){v.forEach(function(ta){ha(ma,ta,ra);});}else if(pa.action_type==qa.CHANGE_ARCHIVED_STATUS||pa.action_type==qa.CHANGE_FOLDER){var sa=ma._threads.getThreadMetaNow(pa.thread_id);oa=h.getFromMeta(sa);if(la(oa)&&sa.unread_count>0)ga(ma,oa,ra);v.forEach(function(ta){if(ta!=oa)ha(ma,ta,ra);});}else{oa=pa.folder;if(!la(oa))return;if(pa.action_type==qa.CHANGE_READ_STATUS){if(pa.mark_as_read){ha(ma,oa,ra,pa.timestamp);}else ga(ma,oa,ra,pa.timestamp);}else if(pa.action_type==qa.USER_GENERATED_MESSAGE||pa.action_type==qa.LOG_MESSAGE)if(pa.is_unread)ga(ma,oa,ra,pa.timestamp);}});}function ga(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){var ra=ma._allReadTimestamp[na]||0,sa=ma._threadReadTimestamp[oa]||0,ta=pa||Number.POSITIVE_INFINITY;if(ta>=ra&&ta>=sa&&!qa[oa]){qa[oa]=pa||0;ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ha(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){if(pa){var ra=ma._threadReadTimestamp[oa];if(!ra||ra<pa)ma._threadReadTimestamp[oa]=pa;}var sa=qa[oa];if(pa&&typeof sa=='number'&&pa<sa)return;if(oa in qa){delete qa[oa];ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ia(ma,na,oa){ma._maxCount[na]=false;ba(ma,na,{});ma._allReadTimestamp[na]=Math.max(ma._allReadTimestamp[na]||0,oa||0);ma._threadInformer.updatedUnreadState();}function ja(ma,na){return na.map(ma._serverRequests.convertThreadIDIfAvailable.bind(ma._serverRequests));}function ka(ma,na){v.forEach(function(oa){var pa=da(ma,oa);if(!pa)return;for(var qa in na){var ra=na[qa];if(pa[qa]){pa[ra]=pa[qa];delete pa[qa];}}ba(ma,oa,pa);});}function la(ma){return s(v,ma);}g.subscribe(i.DUMP_EVENT,function(ma,na){na.messaging=na.messaging||{};na.messaging.unread={};na.messaging.unread_max_count={};var oa=aa._getInstances();for(var pa in oa){na.messaging.unread[pa]={};na.messaging.unread_max_count[pa]={};v.forEach(function(qa){na.messaging.unread[pa][qa]=t({},da(oa[pa],qa));na.messaging.unread_max_count[pa][qa]=oa[pa]._maxCount[qa];});}});e.exports=aa;});
__d("MercuryChatUtils",["Env"],function(a,b,c,d,e,f){var g=b('Env'),h={canOpenChatTab:function(i){var j=i.is_canonical&&!i.is_canonical_user;return i.is_subscribed&&!j&&i.canonical_fbid!=g.user;}};e.exports=h;});
__d("RenderManager",["function-extensions","copyProperties"],function(a,b,c,d,e,f){b('function-extensions');var g=b('copyProperties');function h(i){this._isDirty=false;this._obj=i;}h.prototype.dirty=function(){if(!this._isDirty){this._isDirty=true;this._doPaint.bind(this).defer();}};h.prototype._doPaint=function(){this._isDirty=false;this._obj.paint();};e.exports=h;});
__d("CounterDisplay",["Arbiter","CSS","DOM","RenderManager","Run","$","copyProperties","removeFromArray"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('RenderManager'),k=b('Run'),l=b('$'),m=b('copyProperties'),n=b('removeFromArray');function o(p,q,r,s,t,u){m(this,{_name:p,_valueNode:l(q),_wrapperNode:l(r)||null,_statusClass:t,_rm:new j(this),_arbiterSubscription:null,_count:0});var v=this._valueNode.firstChild;if(v){var w=parseInt(v.nodeValue,10);if(!isNaN(w))this._count=w;}this._statusNode=s?l(s):null;this._subscribeAll();o.instances.push(this);if(!u)k.onLeave(this._destroy.bind(this),true);}m(o,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(p,q){g.inform(o.EVENT_TYPE_ADJUST+'/'+p,q);},setCount:function(p,q){g.inform(o.EVENT_TYPE_UPDATE+'/'+p,q);}});m(o.prototype,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){this._arbiterSubscription.unsubscribe();delete this._arbiterSubscription;}n(o.instances,this);},adjustCount:function(p){this._count=Math.max(0,this._count+p);this._rm.dirty();return this;},setCount:function(p){this._count=Math.max(0,p);this._rm.dirty();return this;},paint:function(){i.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)h.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)h.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var p=[o.EVENT_TYPE_ADJUST+'/'+this._name,o.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=g.subscribe(p,this._onInform.bind(this),g.SUBSCRIBE_NEW);},_onInform:function(p,q){q=parseInt(q);if(isNaN(q))return;if(p.indexOf(o.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(q);}else if(p.indexOf(o.EVENT_TYPE_UPDATE)!=-1){this.setCount(q);}else return;return;}});e.exports=o;});