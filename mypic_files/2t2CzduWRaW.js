/*!CK:3145511045!*//*1375705729,173209403*/

if (self.CavalryLogger) { CavalryLogger.start_js(["e0RyX"]); }

__d("PhotoSnowliftAds",["Event","copyProperties","CSS","csx","DataStore","DOM","PhotoSessionLog","UIPagelet","URI","Vector","extendArray"],function(a,b,c,d,e,f){var g=b('Event'),h=b('copyProperties'),i=b('CSS'),j=b('csx'),k=b('DataStore'),l=b('DOM'),m=b('PhotoSessionLog'),n=b('UIPagelet'),o=b('URI'),p=b('Vector'),q=b('extendArray'),r={DEFAULT_UNITS_REFRESH_RATE:30000,UNITS_REGISTER_DELAY:1000,root:null,availableDimensions:null,loadQuery:null,lastLoadTime:0,minAds:100,units:null,isLogAdData:null,displayedCallback:null,refreshUnitsRate:null,position:null,adsStatus:'null',adsEvents:{},snowliftRedesign:false,resetEvents:function(){this.adsStatus='reset';this.adsEvents={};},addEvent:function(s,t){if(t)this.adsStatus=s;var u=Date.now();this.adsEvents[s+'_'+u]=u;},init:function(s,t,u,v){this.reset();this.root=s;this.snowlift=t;this.minAds=u.min_ads;this.displayedCallback=v;this.addEvent('init',true);this.snowliftRedesign=u.snowlift_redesign;this.refreshUnitsRate=r.DEFAULT_UNITS_REFRESH_RATE;if(u.refresh_fast)this.refreshUnitsRate=u.refresh_rate;},reset:function(){this.lastLoadTime=0;this.position=0;this.units=[];this.resetEvents();this.addEvent('reset',true);},resize:function(s){this.availableDimensions=s;this.loadQuery=this.snowlift.getLoadQuery();this.processResize();},calculateUnitSizes:function(s,t,u){var v={};s.forEach(function(w){var x=w.root.firstChild.offsetHeight;w.units.forEach(function(z){if(!i.hasClass(z,'hidden')&&!this.getIsHoldout(z)){var aa=this.getHeight(z.firstChild,t);x-=aa;}}.bind(this));var y={height:x,visible:false};w.units.forEach(function(z){var aa=this.getIsAds(z),ba=this.getHeight(z.firstChild,t),ca=this.getUnitId(z),da=this.getIsHoldout(z);if(da&&u)return;v[ca]={height:ba,visible:false,priority:0,is_ads:aa,is_holdout:da,section_ref:y};}.bind(this));}.bind(this));return v;},calculateVisibleUnits:function(s,t,u){var v=0,w=this.getUnitPriority(t);w.forEach(function(x){if(t.hasOwnProperty(x)){var y=t[x],z=y.height;if(!y.section_ref.visible)z+=y.section_ref.height;y.height_below=u-z;y.visible=y.height_below>=0&&z>0;if(y.visible){y.section_ref.visible=true;u-=z;v++;}}}.bind(this));return t;},displayUnits:function(s,t){s.forEach(function(u){var v=false,w=true;u.units.forEach(function(x){var y=this.getUnitId(x),z=t[y];if(!z)return;var aa=z.visible,ba=z.height_below,ca=z.is_ads;i.conditionClass(x,'hidden',!aa);if(ca&&aa&&w){var da=l.find(x,'div.ego_unit');i.addClass(da,'ego_unit_no_top_border');w=false;}v=v||aa;this.calcUnitStats(this.units[ca][y],aa,ba);}.bind(this));i.conditionClass(u.root,'hidden',!v);}.bind(this));},getUnitsDisplayed:function(s,t){var u=0;s.forEach(function(v){v.units.forEach(function(w){var x=this.getUnitId(w),y=t[x];if(!y||!y.visible)return;u++;}.bind(this));}.bind(this));return u;},getHeightsRequired:function(s,t){var u=0,v=[];s.forEach(function(w){var x=false;w.units.forEach(function(y){var z=this.getUnitId(y),aa=t[z];if(!aa)return;u+=aa.height;if(!x){u+=aa.section_ref.height;x=true;}v.push(u);}.bind(this));}.bind(this));return v;},getUnitPriority:function(s){var t=[],u=0,v=0;for(var w in s){var x=s[w];t.push(w);var y=this.minAds+u+v;if(x.is_ads){if(v<this.minAds)y=v;v++;}else u++;x.priority=y;}t=t.sort(function(z,aa){var ba=s[z],ca=s[aa];return ba.priority-ca.priority;}.bind(this));return t;},updateUnitsStatus:function(){var s=this.availableDimensions.x,t=this.availableDimensions.y,u=this.calculateUnitSizes(this.sections,s);u=this.calculateVisibleUnits(this.sections,u,t);for(var v in u){if(!u.hasOwnProperty(v))continue;var w=u[v];if(!w.is_holdout||!w.visible)continue;var x=this.units[1][v];this.calcUnitStats(x,w.visible,w.height_below);}u=this.calculateUnitSizes(this.sections,s,true);u=this.calculateVisibleUnits(this.sections,u,t);this.displayUnits(this.sections,u);if(this.displayedCallback){var y=this.getUnitsDisplayed(this.sections,u),z=this.getHeightsRequired(this.sections,u);this.displayedCallback(y,z);}},calcUnitStats:function(s,t,u){var v=Date.now();if(s.visible)s.totalTime+=v-s.lastShowTime;if(s.trackingCode!==null&&s.totalTime>=this.UNITS_REGISTER_DELAY){var w=s.trackingCode;s.trackingCode=null;this.registerImpression(w,s.registerUrl);}s.visible=t;s.heightBelow=u;s.lastShowTime=v;},prepareResize:function(){var s=function(t){var u=l.create('div',{className:'inner'}),v=l.create('div',{className:'wrapper'},u);l.replace(t,v);l.setContent(u,t);return v;};this.sections=l.scry(this.root,'div.ego_section').map(function(t){return {root:s(t),units:l.scry(t,'div.ego_unit').map(s)};});},processResize:function(){if(this.isLoading||this.lastLoadTime===0||this.availableDimensions===null){this.setLogData();return;}this.updateUnitsStatus();this.setLogData();var s=this.nextRegisterTime();if(s!==Infinity)this.processResize.bind(this).defer(s,true);},setIsLogAdData:function(s){this.isLogAdData=s;this.addEvent('setIsLogAdData',false);this.setLogData();},setLogData:function(){var s=this.snowlift.getImageId();if(this.isLogAdData&&s){var t=p.getElementDimensions(this.snowlift.getImage()),u=p.getElementDimensions(this.snowlift.getRHCHeader()),v=p.getElementDimensions(this.snowlift.getRHCBody()),w=p.getElementDimensions(this.snowlift.getRHCFooter()),x={query_set:this.snowlift.getLoadQuery().set,window_x:window.innerWidth,window_y:window.innerHeight,image_x:t.x,image_y:t.y,header_x:u.x,header_y:u.y,body_x:v.x,body_y:v.y,footer_x:w.x,footer_y:w.y,ads_below_space:this.getAdsBelowSpace(),time:Date.now(),adsStatus:this.adsStatus,adsEvents:this.adsEvents,refreshRate:this.refreshUnitsRate,position:this.position};m.updateAdData(s,x);}},getAdsBelowSpace:function(){var s=[],t=this.units[1];for(var u in t)if(t.hasOwnProperty(u)&&!this.getIsHoldout(this.getAdUnit(u)))s.push(t[u].heightBelow);return s;},getIsAds:function(s){var t=l.scry(s,"div._4u8");return t.length;},getUnitId:function(s){if(this.getIsAds(s)){return this.getAdId(s);}else return this.getEgoId(s);},getEgoId:function(s){var t=l.find(s,'div.ego_unit');return t.getAttribute('data-ego-fbid');},getAdData:function(s){var t=l.find(s,"div._4u8"),u=t.getAttribute('data-ad');return u&&JSON.parse(u)||{};},getAdId:function(s){return this.getAdData(s).adid;},getIsHoldout:function(s){return s&&this.getIsAds(s)&&this.getAdData(s).holdout;},getAdUnit:function(s){if(!this.sections)return null;var t=[];this.sections.forEach(function(v){q(t,v.units);});for(var u=0;u<t.length;u++)if(this.getIsAds(t[u])&&this.getAdId(t[u])==s)return t[u];return null;},nextRegisterTime:function(){var s=Infinity,t=h(h({},this.units[0]),this.units[1]);for(var u in t)if(t.hasOwnProperty(u)){var v=t[u];if(v.trackingCode!==null&&v.visible)s=Math.min(s,this.UNITS_REGISTER_DELAY-v.totalTime);}return s;},getHeight:function(s,t){var u=k.get(s,'height');if(u&&u.x===t)return u.y;return this.cacheHeight(s,t);},cacheHeight:function(s,t){var u={x:t,y:s.offsetHeight};k.set(s,'height',u);return u.y;},loadAdsAndEgo:function(){this.resetEvents();this.addEvent('adsRequested',true);this.position++;var s=this.getCursorFBID(this.loadQuery);n.loadFromEndpoint('WebEgoPane',this.root,{pid:34,data:[this.loadQuery.set,s,this.snowliftRedesign,this.snowlift.getOpaqueCursor(s)]},{crossPage:true,bundle:false});},getCursorFBID:function(s){if(s.v!==undefined)return s.v;if(s.fbid!==undefined)return s.fbid;return '0';},unitsLoaded:function(s,t){var u;if(t){u='/ai.php';this.addEvent('adsLoaded',true);}else{u='/ajax/ei.php';this.addEvent('egoLoaded',true);}var v={};for(var w in s)if(s.hasOwnProperty(w))v[w]={trackingCode:s[w],totalTime:0,lastShowTime:0,heightBelow:-10000,visible:false,registerUrl:u};this.units[t]=v;if(t)this.waitForImages(this.imagesLoaded.bind(this));},imagesLoaded:function(){this.prepareResize();this.addEvent('imagesLoaded',true);this.lastLoadTime=Date.now();this.isLoading=false;this.processResize();i.removeClass(this.root,'loading');},loadAdsFromUserActivity:function(){var s=Date.now(),t=this.refreshUnitsRate;if(!this.isLoading&&s-this.lastLoadTime>t){i.addClass(this.root,'loading');this.isLoading=true;this.loadAdsAndEgo();}},registerImpression:function(s,t){var u=l.create('iframe',{src:o(t).addQueryData({aed:s}),width:0,height:0,frameborder:0,scrolling:'no',className:'fbEmuTracking'});u.setAttribute('aria-hidden','true');l.appendContent(this.root,u);},waitForImages:function(s){var t=l.scry(this.root,'img.img'),u=t.length,v=u;if(v===0)s();var w=function(){v--;if(v===0)s.defer();};for(var x=0;x<u;x++){var y=t[x];if(y.complete){w();}else g.listen(y,{load:w,error:w,abort:w});}}};e.exports=r;});
__d("PhotoSnowlift",["function-extensions","Arbiter","AsyncDialog","AsyncRequest","Bootloader","Class","collectDataAttributes","CSS","Dialog","DOM","DOMControl","Event","FullScreen","Input","ImageUtils","Keys","Layer","LinkController","Locale","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoSnowliftAds","PhotoStreamCache","PhotosUtils","PhotoViewer","Rect","ScrollableArea","Style","Toggler","UIPagelet","URI","UserAgent","Vector","$","asyncCallback","computeRelativeURI","copyProperties","createArrayFrom","csx","cx","emptyFunction","ge","goURI","shield","startsWith","tx","userAction","Assert"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('AsyncDialog'),i=b('AsyncRequest'),j=b('Bootloader'),k=b('Class'),l=b('collectDataAttributes'),m=b('CSS'),n=b('Dialog'),o=b('DOM'),p=b('DOMControl'),q=b('Event'),r=b('FullScreen'),s=b('Input'),t=b('ImageUtils'),u=b('Keys'),v=b('Layer'),w=b('LinkController'),x=b('Locale'),y=b('PageTransitions'),z=b('Parent'),aa=b('PhotosConst'),ba=b('PhotoSessionLog'),ca=b('PhotoSnowliftAds'),da=b('PhotoStreamCache'),ea=b('PhotosUtils'),fa=b('PhotoViewer'),ga=b('Rect'),ha=b('ScrollableArea'),ia=b('Style'),ja=b('Toggler'),ka=b('UIPagelet'),la=b('URI'),ma=b('UserAgent'),na=b('Vector'),oa=b('$'),pa=b('asyncCallback'),qa=b('computeRelativeURI'),ra=b('copyProperties'),sa=b('createArrayFrom'),ta=b('csx'),ua=b('cx'),va=b('emptyFunction'),wa=b('ge'),xa=b('goURI'),ya=b('shield'),za=b('startsWith'),ab=b('tx'),bb=b('userAction'),cb=b('Assert'),db=74,eb=75,fb=70,gb=76;function hb(){this.parent.construct(this);}ra(hb,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',LOADING_TIMEOUT:2000,PAGER_FADE:3000,FULL_SCREEN_PADDING:10,STAGE_HIRES_MAX:{x:2048,y:2048},STAGE_NORMAL_MAX:{x:960,y:960},STAGE_MIN:{x:520,y:520},SIDEBAR_SIZE_MAX:360,STAGE_CHROME:{x:82,y:42},VIDEO_BOTTOM_BAR_SPACE:40,GOPREV_AREA:120,TIMELINE_STRETCH_WIDTH:843,TIMELINE_STRETCH_MIN:480,MIN_TAG_DISTANCE:83,PADDING_MIN:40,MIN_UFI_HEIGHT:250,COLLECTIONS_UNTAGGED_PHOTOS:3,PHOTOS_OF_YOU_SUGGESTIONS:28,FRIENDS_IN_PHOTOS_SUGGESTIONS:31,MIN_ADS_VISIBLE:1,RESERVED_ADS_HEIGHT:150,PINNED_UFI_ADJUSTMENT:11,ADD_COMMENT_HEIGHT:54,_instance:null,getInstance:function(){if(!hb._instance)hb._instance=new hb();return hb._instance;},initWithSpotlight:function(ib,jb){hb.getInstance().init(ib,jb);},touch:va,addPhotoFbids:function(ib,jb,kb,lb){hb.getInstance().addPhotoFbids(ib,jb,kb,lb);},setReachedLeftEnd:function(){hb.getInstance().setReachedLeftEnd();},setReachedRightEnd:function(){hb.getInstance().setReachedRightEnd();},attachFollowFlyout:function(ib){o.insertAfter(oa('fbPhotoSnowliftSubscribe'),ib);},attachSubscribeFlyout:function(ib){o.insertAfter(oa('fbPhotoSnowliftSubscribe'),ib);},attachTagger:function(ib){hb.getInstance().attachTagger(ib);},preload:function(ib,jb){hb.getInstance().preload(ib,jb);},bootstrap:function(ib,jb){if(ib&&la(ib).getQueryData().hasOwnProperty('share_id')){j.loadModules(['SpotlightShareViewer'],function(kb){kb.bootstrap(ib,jb);});return;}hb.getInstance().bootstrap(ib,jb);},closeRefresh:function(){hb.getInstance().closeRefresh();},deletePhoto:function(ib){hb.getInstance().deletePhoto(ib);},getImage:function(){return hb.getInstance().getImage();},getImageId:function(){return hb.getInstance().getImageId();},getLoadQuery:function(){return hb.getInstance().getLoadQuery();},getRHCBody:function(){return hb.getInstance().getRHCBody();},getRHCFooter:function(){return hb.getInstance().getRHCFooter();},getRHCHeader:function(){return hb.getInstance().getRHCHeader();},getRoot:function(){return hb.getInstance().getRoot();},likePhotoSkipConfirmation:function(ib){hb.getInstance().likePhotoSkipConfirmation(ib);},saveTagsFromPayload:function(ib){hb.getInstance().saveTagsFromPayload(ib);},saveTagsFromPayloadDelayed:function(ib){hb.saveTagsFromPayload.curry(ib).defer(2000);},handleServerError:function(ib,jb){hb.getInstance().handleServerError(ib,jb);},setVideoWarning:function(ib,jb){var kb=hb.getInstance(),lb='video_warning_'+ib;if(!kb.videoWarnings)kb.videoWarnings=[];kb.videoWarnings[lb]=jb;},storeFromData:function(ib){hb.getInstance().storeFromData(ib);},swapData:function(){hb.getInstance().swapData();},touchMarkup:va,updateTotalCount:function(ib,jb,kb){hb.getInstance().updateTotalCount(ib,jb,kb);},setVideoRotateURI:function(ib){hb.getInstance().videoRotateURI=ib;}});k.extend(hb,fa);ra(hb.prototype,{switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,currentImageSize:null,resetUriStack:true,thumbSrc:null,shouldStretch:false,stageMax:hb.STAGE_NORMAL_MAX,stageChrome:hb.STAGE_CHROME,stagePagerPrev:null,ua:null,PhotoTagger:null,showHover:false,skipLikePhotoConfirmation:false,isShowingLikePhotoConfirmation:false,preload:function(ib,jb){j.loadModules(['PhotoTagger','Live','PhotoTagApproval','PhotoTags','TagTokenizer','fb-photos-snowlift-fullscreen-css'],function(lb){this.PhotoTagger=lb;}.bind(this));var kb=this.getImageSrc(la(ib).getQueryData());if(kb)(new Image()).src=kb;},bootstrap:function(ib,jb){if(ib&&la(ib).getQueryData().makeprofile){this.enableCropperOnInit=true;this.isUserProfilePic=la(ib).getQueryData().makeuserprofile;this.isInProfilePicAlbum=la(ib).getQueryData().inprofilepicalbum;}this.preload(ib,jb);if(this.closeDirty){this.bootstrap.bind(this,ib,jb).defer();return;}ca.reset();this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=bb('snowlift',jb).uai('open');this.returningToStart=false;this.loading&&m.removeClass(this.loading,'loading');if(jb){m.addClass((this.loading=jb),'loading');if(this.container){var kb=z.byClass(jb,'uiStreamStory');if(kb){this.container.setAttribute('data-ownerid',kb.id);}else this.container.removeAttribute('data-ownerid');}this.getThumbAndSize(jb);}else this.loading=null;g.inform('PhotoSnowlift.GO',ib,g.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getCurrentImageServerSizeDimensions:function(){return this.stream.getCurrentImageData().dimensions;},getEventPrefix:function(){return 'PhotoSnowlift';},getRoot:function(){return this.root;},getSourceString:function(){return 'snowlift';},getViewerSource:function(){return this.source;},getViewerSet:function(){return this.stream.getPhotoSet();},getVersionConst:function(){return aa.VIEWER_SNOWLIFT;},getImage:function(){return this.image;},getImageId:function(){return this.stream.getCursor();},getRHCHeader:function(){return this.rhcHeader;},getRHCBody:function(){return this.ufiForm;},getRHCFooter:function(){return this.rhcFooter;},getLoadQuery:function(){return this.loadQuery;},getCurrentPhotoInfo:function(){var ib=this.stream.getCurrentImageData();if(ib)return ib.info;return null;},getOwnerId:function(){var ib=this.stream.getCurrentImageData();if(ib)return ib.info.owner;return null;},getThumbAndSize:function(ib){this.currentImageSize=null;this.thumbSrc=null;var jb=la(ib.getAttribute('ajaxify')).getQueryData();if(!jb.size)return;var kb=na.deserialize(jb.size);if(!kb.x||!kb.y)return;this.currentImageSize=kb;if(!m.hasClass(ib,'uiMediaThumb')&&!m.hasClass(ib,'uiPhotoThumb')&&!m.hasClass(ib,'uiScaledThumb'))return;if(ib.getAttribute('data-cropped'))return;var lb=o.scry(ib,'img')[0],mb=o.scry(ib,'i')[0],nb=z.byAttribute(ib,'data-size');this.shouldStretch=nb&&this.currentImageSize&&lb&&nb.getAttribute('data-size')==="2"&&this.currentImageSize.x>this.currentImageSize.y&&this.currentImageSize.x<=hb.TIMELINE_STRETCH_WIDTH&&lb.offsetWidth===hb.TIMELINE_STRETCH_WIDTH;var ob;if(lb){ob=lb.src;}else if(mb){ob=ia.get(mb,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=ob;},loadFrameIfUninitialized:function(){if(this.root)return;new i('/ajax/photos/snowlift/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(ib,jb){this.init=va;this.showHover=jb.pivot_hover;ba.setEndMetrics(jb.pivot_end_metric);this.enableSnowliftProfilePicCropper=jb.snowlift_profile_pic_cropper;this.pagersOnKeyboardNav=jb.pagers_on_keyboard_nav;this.hilitAllTagsAndBoxesOnHover=jb.snowlift_hover_shows_all_tags_and_faces;this.shouldKeepFacebox=jb.keep_facebox_on_click;this.startingMousePos=null;this.haveLeftBufferRegion=false;this.showingTypeaheadSuggestions=false;this.fullscreen=r.isSupported();this.showOGVideos=jb.og_videos;this.resizeCommentsForAds=jb.resize_comments_for_ads;if(this.resizeCommentsForAds)hb.STAGE_MIN.y=600;this.stageMax=hb.STAGE_HIRES_MAX;this.spotlight=ib;this.spotlight.subscribe('blur',function(){this.closingAction=ba.OUTSIDE;}.bind(this));this.spotlight.subscribe('hide',ya(this.closeHandler,this));this.spotlight.subscribe('key',this.keyHandler.bind(this));this.initializeNodes(this.spotlight.getRoot());ca.init(this.sideAdUnit,this,jb,this.adsDisplayedCallback.bind(this));this.inAdsDisplayedCallback=false;this.lastAdsHeight=this.resizeCommentsForAds?hb.RESERVED_ADS_HEIGHT:0;if(!this.subscription){w.registerHandler(this.handleNavigateAway.bind(this));this.subscription=g.subscribe('PhotoSnowlift.GO',function(kb,lb){this.openExplicitly=true;this.loading&&m.removeClass(this.loading,'loading');this.open(lb);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;y.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));if(this.fullscreen)r.subscribe('changed',this.onFullScreenChange.bind(this));this.redesign=jb.snowlift_redesign;},onFullScreenChange:function(){var ib=r.isFullScreen();m.conditionClass(document.body,'fbPhotoSnowliftFullScreenMode',ib);if(ib){if(!m.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.collapseRHC();var jb=this.stream.getCurrentImageData();if(jb&&jb.url&&this.image.src!==jb.url&&this.shouldShowHiRes(jb))this.switchImage(jb.url);this.adjustForResize();}else{this.uncollapseRHC();if(ma.chrome()&&!m.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.page(0,false);g.inform('reflow');}ja.hide();if(this.cropper)this.cropper.resetPhoto();},initializeNodes:function(ib){this.root=ib;this.container=o.find(ib,'div.fbPhotoSnowliftContainer');this.snowliftPopup=o.find(this.container,'div.fbPhotoSnowliftPopup');this.rhc=o.find(this.snowliftPopup,'div.rhc');this.rhcHeader=o.find(this.rhc,'div.rhcHeader');this.rhcFooter=o.find(this.rhc,'div.rhcFooter');this.ufiForm=o.find(this.rhc,'form.fbPhotosSnowliftFeedbackForm');this.ufiInputContainer=o.find(this.rhc,'div.fbPhotosSnowboxFeedbackInput');this.scroller=o.find(this.ufiForm,'div.rhcScroller');this.scrollerBody=o.find(this.scroller,'div.uiScrollableAreaBody');this.stageWrapper=o.find(this.snowliftPopup,'div.stageWrapper');this.overlay=o.find(this.snowliftPopup,'div.snowliftOverlay');this.errorBox=o.find(this.stageWrapper,'div.stageError');this.image=o.find(this.stageWrapper,'img.spotlight');this.stage=o.find(this.stageWrapper,'div.stage');this.videoStage=o.find(this.stageWrapper,'div.videoStage');this.prevPager=o.find(this.snowliftPopup,'a.snowliftPager.prev');this.nextPager=o.find(this.snowliftPopup,'a.snowliftPager.next');this.stageActions=o.find(ib,'div.stageActions');this.buttonActions=o.find(this.stageActions,'div.fbPhotosPhotoButtons');this.productMetadata=o.scry(this.rhc,'div.fbPhotosSnowliftProductMetadata').pop();this.sideAdUnit=o.find(ib,"._5ciw");g.inform('Amoeba/instrumentMulti',[[this.container,'snowlift'],[this.rhc,'rhc'],[this.rhcHeader,'rhc_header'],[this.ufiForm,'ufi_form'],[this.ufiInputContainer,'ufi_input'],[this.prevPager,'prev_pager'],[this.nextPager,'next_pager'],[this.stageActions,'stage_actions'],[this.sideAdUnit,'side_ads']],g.BEHAVIOR_PERSISTENT);m.conditionClass(this.root,'fullScreenAvailable',this.fullscreen);},initializeScroller:function(){this.initializeScroller=va;this.scrollableArea=ha.fromNative(this.scroller,{fade:true,persistent:true});var ib=function(event){var jb=q.$E(event).getTarget();if(o.contains(this.ufiInputContainer,jb)){var kb=p.getInstance(jb);if(kb){this.scrollableArea.scrollToBottom();var lb=kb.subscribe('resize',function(){var nb=this.scrollableArea.isScrolledToBottom();this.adjustScroller();nb&&this.scrollableArea.scrollToBottom();}.bind(this)),mb=q.listen(jb,'blur',function(){kb.unsubscribe(lb);mb.remove();});}}}.bind(this);g.subscribe('ufi/changed',function(jb,kb){if(this.ufiForm===kb.form)this.adjustScrollerIfNecessary();}.bind(this));g.subscribe('ufi/comment',function(jb,kb){if(this.ufiForm===kb.form){this.adjustScrollerIfNecessary();if(kb.isranked){this.scrollableArea.scrollToTop();}else this.scrollableArea.scrollToBottom();}}.bind(this));q.listen(this.rhc,'click',function(event){var jb=event.getTarget();if(z.byTag(jb,'a')||z.byTag(jb,'button')||o.isNodeOfType(jb,'input'))this.adjustScrollerIfNecessary();}.bind(this));g.subscribe(['reflow','CommentUFI.Pager'],function(){if(this.isOpen)this.adjustScrollerIfNecessary();}.bind(this));q.listen(this.ufiForm,'focusin',ib);},openHandler:function(ib){if(this.isOpen||ib.getPath()!='/photo.php'||this.returningToStart||ib.getQueryData().closeTheater||ib.getQueryData().permPage||ib.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(ib);this._uriStack.push(la(ib).getQualifiedURI().toString());y.transitionComplete(true);return true;},getImageSrc:function(ib){if(ib.smallsrc){if(!ib.size)return ib.smallsrc;var jb=na.deserialize(ib.size),kb=this.getStageSize(jb);if(kb.x<=hb.STAGE_NORMAL_MAX.x&&kb.y<=hb.STAGE_NORMAL_MAX.y)return ib.smallsrc;}return ib.src;},open:function(ib){var jb=la(ib).getQueryData(),kb=this.getImageSrc(jb);if(kb){delete jb.src;delete jb.smallsrc;}if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){jb.firstLoad=true;this.initialLoad=true;}this.sessionID=Date.now();this.sessionPhotosHilited={};this.loadQuery=ra(jb,{ssid:this.sessionID});this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.source=null;this.saveTagSubscription=g.subscribe('PhotoTagger.SAVE_TAG',this.onTagSaved.bind(this));this.taggedPhotoIds=[];this.stream=new da();this.stream.init(aa.VIEWER_SNOWLIFT,'PhotoViewerPagelet','pagelet_photo_viewer');this.fetchInitialData();this.setLoadingState(hb.STATE_HTML,true);this.rhcCollapsed=false;this._open(ib,kb);if(this.enableSnowliftProfilePicCropper)j.loadModules(['SnowliftPicCropper'],function(lb){this.cropper=lb.getInstance(this);this.cropper.init();if(this.enableCropperOnInit){var mb=g.subscribe('PhotoSnowlift.SWITCH_IMAGE',function(){if(this.isInProfilePicAlbum){this.cropper.showPicInProfileAlbumDialog();}else this.cropper.enableCropping(this.isUserProfilePic);g.unsubscribe(mb);}.bind(this));this.enableCropperOnInit=false;}}.bind(this));j.loadModules(['PhotosButtonTooltips'],function(lb){lb.init();});},_open:function(ib,jb){this.createLoader(jb);this.spotlight.show();this.ua&&this.ua.add_event('frame');g.inform('layer_shown',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.OPEN');this.stageHandlers=[q.listen(window,'resize',this.adjustForResize.bind(this)),q.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),q.listen(this.stageWrapper,'mouseleave',function(event){var mb=event.getTarget();if(!(z.byClass(mb,'snowliftOverlay')||z.byClass(mb,'fbPhotoSnowliftTagApproval')||z.byClass(mb,'tagPointer')||z.byClass(mb,'arrow')||z.byClass(mb,'faceboxSuggestion')||z.byClass(mb,'typeaheadWrapper')||z.byClass(mb,'photoTagTypeahead')))this.unhiliteAllTags();this.hidePagers();}.bind(this)),q.listen(this.stageWrapper,'mousemove',this.hilitePagerOnMouseMove.bind(this)),q.listen(this.stageWrapper,'mousemove',this.hiliteTagsOnMouseMove.bind(this)),q.listen(this.overlay,'mouseenter',this.unhiliteAllTags.bind(this))];this.stageHandlers.push(q.listen(this.container,'click',function(event){var mb=event.getTarget();if(z.byClass(mb,'rotateRight')){this.rotate('right');}else if(z.byClass(mb,'rotateLeft')){this.rotate('left');}else if(z.byClass(mb,'closeTheater')){if(r.isFullScreen()){r.toggleFullScreen();return;}this.closingAction=ba.X;this.closeHandler();return false;}else if(this.fullscreen)if(z.byClass(mb,'fbPhotoSnowliftFullScreen')){this.toggleFullScreen();}else if(z.byClass(mb,'fbPhotoSnowliftCollapse'))this.toggleCollapse();}.bind(this)));var kb=wa('fbPhotoSnowliftFeedback');if(kb)this.stageHandlers.push(q.listen(kb,'click',function(event){var mb=event.getTarget();if(z.byClass(mb,'like_link')||(z.byClass(mb,'UFILikeLink')&&z.byClass(mb,'UIActionLinks'))||(this.redesign&&z.byClass(mb,"_6k6")))this.toggleLikeButton();var nb=z.byClass(event.getTarget(),'uiUfiCollapsedComment');if(nb)m.addClass(nb,'uiUfiCollapsedCommentToggle');}.bind(this)));var lb=wa('fbPhotoSnowliftOnProfile');if(lb)this.stageHandlers.push(q.listen(lb,'click',function(event){if(z.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=la.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!jb)this.setLoadingState(hb.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){y.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}ba.initLogging(ba.SNOWLIFT);if(this.pivots)ba.setRelevantCount(this.pivots.relevantCount);},toggleFullScreen:function(){var ib=r.toggleFullScreen(document.documentElement);if(ib){var jb=this.stream.getCurrentImageData();if(jb&&jb.url&&this.image.src!==jb.url&&this.shouldShowHiRes(jb))(new Image()).src=jb.url;ba.logEnterFullScreen(this.stream.getCursor());}},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua&&this.ua.add_event('init_data');this.stream.waitForInitData();var ib=l(this.container,['ft']);if(ib&&ib.ft&&ib.ft.ei&&this.loadQuery)this.loadQuery.ei=ib.ft.ei;ka.loadFromEndpoint('PhotoViewerInitPagelet',wa('pagelet_photo_viewer_init',this.root),this.loadQuery,{usePipe:true,jsNonblock:true,crossPage:true});},toggleCollapse:function(){if(this.rhcCollapsed){this.uncollapseRHC();}else this.collapseRHC();},collapseRHC:function(){this.rhcCollapsed=true;m.addClass(this.root,'collapseRHC');this.adjustForResize();},uncollapseRHC:function(){this.rhcCollapsed=false;m.removeClass(this.root,'collapseRHC');this.adjustForResize();},closeHandler:function(){if(!this.isOpen)return;this.closingAction=this.closingAction||ba.ESC;if(la.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.returnToStartingURI(this.refreshOnClose);this.close();},returnToStartingURI:function(ib,jb){if(!ib)if(jb){this.squashNextTransition(xa.curry(jb));}else this.squashNextTransition();this.returningToStart=true;var kb=g.subscribe('page_transition',(function(){this.returningToStart=false;kb.unsubscribe();}).bind(this)),lb=ib||isNaN(ma.opera()),mb=this._uriStack.length;if(lb&&mb<window.history.length){window.history.go(-mb);}else{var nb=this.startingURI,ob=new la(nb).removeQueryData('closeTheater');if(nb.getQueryData().sk=='approve'&&nb.getPath()=='/profile.php'){ob.removeQueryData('highlight');ob.removeQueryData('notif_t');}xa(ob);}},squashNextTransition:function(ib){this.squashNext=true;y.registerHandler(function jb(){if(this.squashNext){this.squashNext=false;if(ib)ib.defer();y.transitionComplete(true);return true;}return false;}.bind(this),7);},handleNavigateAway:function(ib){var jb=qa(y._most_recent_uri.getQualifiedURI(),ib.getAttribute('href'));if(this.isOpen&&za(jb.getPath(),'/hashtag/')){this.close();return true;}if(this.isOpen&&(jb instanceof la)&&jb.getUnqualifiedURI().toString()!=this.startingURI.toString()&&jb.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=ba.NAVIGATE;this.returnToStartingURI(false,jb);this.close();return false;}return true;},postProcessTaggedPhotos:function(){if(this.taggedPhotoIds&&this.taggedPhotoIds.length>0){var ib=null;if(this.source===hb.COLLECTIONS_UNTAGGED_PHOTOS){ib='/ajax/photos/photo/edit/skiptag/';}else if(this.source===hb.PHOTOS_OF_YOU_SUGGESTIONS||this.source===hb.FRIENDS_IN_PHOTOS_SUGGESTIONS)ib='/ajax/photos/photo/add_to_star_grid/';if(ib)new i().setURI(ib).setAllowCrossPageTransition(true).setData({media_id:this.taggedPhotoIds,source:this.source}).send();}},onTagSaved:function(ib,jb){if(this.taggedPhotoIds){if(this.source===hb.PHOTOS_OF_YOU_SUGGESTIONS&&!jb.self_tag)return;this.taggedPhotoIds.push(jb.photo_fbid);}},close:function(){if(!this.isOpen)return;this.isOpen=false;if(this.fullscreen)r.disableFullScreen();bb('snowlift').uai('close');this.cropper&&this.cropper.disableCropping();this.spotlight.hide();this.openExplicitly=false;this.postProcessTaggedPhotos();g.unsubscribe(this.saveTagSubscription);this.taggedPhotoIds=[];this.closeDirty=true;this.closeCleanup.bind(this).defer();},closeCleanup:function(){this.closeDirty=false;m.removeClass(this.root,'dataLoading');ba.logPhotoViews(this.closingAction);this.destroy();m.hide(this.errorBox);m.hide(this.image);this.currentImageSize=null;this.thumbSrc=null;this.shouldStretch=false;this.resetUriStack=true;m.removeClass(this.stageWrapper,'showVideo');o.empty(this.videoStage);this.uncollapseRHC();this.currentMinSize=null;this.rhcMinHeight=null;this.setStagePagersState('reset');this.recacheData();o.empty(this.sideAdUnit);this.stream.destroy();var ib=this.closingAction===ba.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){y.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}g.inform('layer_hidden',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.CLOSE',ib);this.root.setAttribute('aria-busy','true');},createLoader:function(ib){if(this.currentImageSize===null){this.adjustStageSize(hb.STAGE_MIN);}else{var jb=this.getStageSize(this.currentImageSize);jb=new na(Math.max(jb.x,hb.STAGE_MIN.x),Math.max(jb.y,hb.STAGE_MIN.y));var kb=this.getImageSizeInStage(this.currentImageSize,jb);if(this.thumbSrc===null){this.adjustStageSize(kb);}else this.useImage(o.create('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:kb.x+'px',height:kb.y+'px'}}),kb,false);}this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(ib)(function(){var lb=new Image(),mb=q.listen(lb,'load',pa(function(){if(!this.isOpen)return;if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(ib,this.currentImageSize);this.ua&&this.ua.add_event('image');this.setLoadingState(hb.STATE_IMAGE_DATA,false);}}.bind(this),'photo_theater')),nb=mb.remove.bind(mb);g.subscribeOnce('PhotoSnowlift.SWITCH_IMAGE',nb);g.subscribeOnce('PhotoSnowlift.CLOSE',nb);lb.src=ib;}).bind(this).defer();m.hide(this.stageActions);this.setStagePagersState('disabled');},initDataFetched:function(ib){ba.setPhotoSet(this.stream.getPhotoSet());ba.setLogFbids(ib.logids);var jb=this.stream.getCurrentImageData();ba.addPhotoView(jb.info,this.shouldShowHiRes(jb),this.fullscreen&&r.isFullScreen());var kb=this.stream.getCurrentExtraData();if(kb&&kb.source!==undefined){this.source=parseInt(kb.source,10);ba.setSource(this.source);}if(!this.pageHandlers)this.pageHandlers=[q.listen(this.root,'click',this.pageListener.bind(this)),q.listen(this.root,'mouseleave',this.mouseLeaveListener.bind(this))];m.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=ib.loggedin;this.disableAdsForSession=ib.disablesessionads||!this.isLoggedInViewer;this.showFlashTags=!!ib.flashtags;this.disableAds=this.disableAdsForSession||ib.fromad;this.loadAds();},adjustScrollerIfNecessary:function(){clearTimeout(this.scrollerTimeout);this.scrollerTimeout=this.adjustScroller.bind(this).defer();},adjustScroller:function(ib){clearTimeout(this.scrollerTimeout);this.initializeScroller();this.scrollableArea.resize();var jb=na.getElementDimensions(this.rhc),kb=jb.y;kb-=na.getElementDimensions(this.rhcHeader).y;kb-=na.getElementDimensions(this.ufiInputContainer).y;if(this.productMetadata){var lb=na.getElementDimensions(this.productMetadata);if(lb.x!==0)kb-=lb.y;}if(ib==null)ib=this.resizeCommentsForAds?this.lastAdsHeight:0;this.lastAdsHeight=ib;this.rhcMinHeight=jb.y-(kb-hb.MIN_UFI_HEIGHT);kb=Math.max(0,kb);var mb=na.getElementDimensions(this.scrollerBody).y,nb=Math.max(hb.MIN_UFI_HEIGHT,kb-ib);if(mb>=nb){if(kb>nb){m.removeClass(this.rhc,'pinnedUfi');kb-=nb;}else{if(this.redesign&&na.getElementDimensions(this.ufiInputContainer).y<hb.ADD_COMMENT_HEIGHT)nb-=hb.PINNED_UFI_ADJUSTMENT;m.addClass(this.rhc,'pinnedUfi');kb=0;}ia.set(this.scroller,'height',nb+'px');}else{ia.set(this.scroller,'height','auto');m.removeClass(this.rhc,'pinnedUfi');kb-=mb;}if(this.redesign){var ob=o.scry(this.ufiInputContainer,'li.UFIAddComment');if(ob.length!==0){var pb=o.scry(this.scrollerBody,'li.UFIComment.display');if(pb.length===0){m.addClass(ob[0],'UFIFirstComponent');}else m.removeClass(ob[0],'UFIFirstComponent');}}var qb=na.getElementDimensions(this.ufiInputContainer).y;ia.set(this.ufiForm,'padding-bottom',qb+'px');ca.resize(new na(jb.x,kb));this.scrollableArea.adjustGripper();},adjustForResize:function(){this.currentMinSize=null;this.adjustStageSize();this.adjustForNewData();},shouldShowHiRes:function(ib){if(!ib||!ib.smallurl)return false;var jb=this.getStageSize(ib.dimensions),kb=this.getImageSizeInStage(ib.dimensions,jb);return (kb.x>hb.STAGE_NORMAL_MAX.x||kb.y>hb.STAGE_NORMAL_MAX.y);},getImageURL:function(ib){if(ib.video){return null;}else if(ib.smallurl&&!this.shouldShowHiRes(ib))return ib.smallurl;return ib.url;},getImageDimensions:function(ib){if(ib.smalldims&&(!this.shouldShowHiRes(ib)||this.image.src===ib.smallurl))return ib.smalldims;return ib.dimensions;},getStageSize:function(ib,jb){var kb=na.getViewportDimensions(),lb=new na(ib.x,ib.y);if(jb)lb=new na(Math.max(ib.x,jb.x),Math.max(ib.y,jb.y));var mb,nb;if(this.fullscreen&&r.isFullScreen()){return new na((this.rhcCollapsed?screen.width:screen.width-hb.SIDEBAR_SIZE_MAX),screen.height-hb.FULL_SCREEN_PADDING*2);}else{mb=Math.min(lb.x,this.stageMax.x,(kb.x-hb.SIDEBAR_SIZE_MAX-hb.STAGE_CHROME.x));nb=Math.min(lb.y,this.stageMax.y,kb.y-hb.STAGE_CHROME.y);}if(mb===0&&nb===0)return new na(0,0);var ob=mb/nb,pb=lb.x/lb.y;if(ob<pb)return new na(mb,Math.round(mb/pb));return new na(Math.round(nb*pb),nb);},getImageSizeInStage:function(ib,jb){var kb=ib.x,lb=ib.y;if(kb>=jb.x||lb>=jb.y){var mb=jb.x/jb.y,nb=kb/lb;if(mb<nb){kb=jb.x;lb=Math.round(kb/nb);}else if(mb>nb){lb=jb.y;kb=Math.round(lb*nb);}else{kb=jb.x;lb=jb.y;}}return new na(kb,lb);},adjustStageSize:function(ib){var jb=this.currentImageSize;if(ib){jb=ib;}else{var kb=this.stream&&this.stream.getCurrentImageData();if(kb)jb=this.getImageDimensions(kb);}if(!jb)return;this.currentImageSize=jb;var lb=0;if(this.shouldStretch&&!this.getVideoOnStage()&&jb.x>jb.y&&jb.x<=hb.TIMELINE_STRETCH_WIDTH&&jb.x>=hb.TIMELINE_STRETCH_MIN){jb.y=Math.round(jb.y*hb.TIMELINE_STRETCH_WIDTH/jb.x);jb.x=hb.TIMELINE_STRETCH_WIDTH;}else if(this.getVideoOnStage())lb=hb.VIDEO_BOTTOM_BAR_SPACE*2;var mb=this.getStageSize(jb,this.currentMinSize);if(!this.currentMinSize)this.currentMinSize=new na(0,0);if(!this.rhcMinHeight)this.rhcMinHeight=0;this.currentMinSize=new na(Math.max(mb.x,hb.STAGE_MIN.x,this.currentMinSize.x),Math.max(mb.y,hb.STAGE_MIN.y,this.currentMinSize.y));var nb=this.getImageSizeInStage(jb,this.currentMinSize),ob=this.currentMinSize.x-nb.x,pb=this.currentMinSize.y-nb.y;if(ob>0&&ob<hb.PADDING_MIN){this.currentMinSize.x-=ob;}else if(pb>0&&pb<hb.PADDING_MIN)this.currentMinSize.y-=pb;var qb=o.scry(this.productMetadata,'#fbPhotoSnowliftTaggedProducts .taggee');if(qb.length)this.currentMinSize.y=Math.max(this.currentMinSize.y,this.rhcMinHeight);var rb=this.currentMinSize.x+hb.SIDEBAR_SIZE_MAX;if(this.rhcCollapsed)rb=this.currentMinSize.x;this.snowliftPopup.style.cssText='width:'+rb+'px;'+'height:'+this.currentMinSize.y+'px;';var sb=this.currentMinSize.y-lb+'px';if(ma.firefox()||ma.ie()<8){var tb=ia.get(this.stageWrapper,'font-size');if(ma.ie()&&tb.indexOf('px')<0){var ub=o.create('div');ub.style.fontSize=tb;ub.style.height='1em';tb=ub.style.pixelHeight;}sb=((this.currentMinSize.y-lb)/parseFloat(tb))+'em';}this.stageWrapper.style.cssText='width:'+this.currentMinSize.x+'px;'+'line-height:'+sb+';';if(ma.ie()<8){ia.set(this.root,'height',na.getViewportDimensions().y+'px');ia.set(this.container,'min-height',(this.currentMinSize.y+hb.STAGE_CHROME.y)+'px');}this.image.style.cssText='width:'+nb.x+'px;'+'height:'+nb.y+'px;';var vb=this.getTagger();if(vb)vb.repositionTagger();this.adjustScrollerIfNecessary();},adjustForNewData:function(){if(!this.image)return;var ib=o.scry(this.stage,'div.tagsWrapper')[0],jb=na.getElementDimensions(this.image);if(ib){ia.set(ib,'width',jb.x+'px');ia.set(ib,'height',jb.y+'px');if(ma.ie()<=7){var kb=o.scry(this.root,'div.tagContainer')[0];if(kb)m.conditionClass(ib,'ie7VerticalFix',na.getElementDimensions(kb).y>jb.y);}}},adsDisplayedCallback:function(ib,jb){var kb=this.resizeCommentsForAds&&!this.inAdsDisplayedCallback&&!this.disableAds&&hb.MIN_ADS_VISIBLE>0&&jb.length>=hb.MIN_ADS_VISIBLE;if(kb){var lb=jb[hb.MIN_ADS_VISIBLE-1],mb=ib<hb.MIN_ADS_VISIBLE||lb!=hb.RESERVED_ADS_HEIGHT;if(mb){this.inAdsDisplayedCallback=true;this.adjustScroller(lb);this.inAdsDisplayedCallback=false;}}},setLoadingState:function(ib,jb){switch(ib){case hb.STATE_IMAGE_PIXELS:m.conditionClass(this.root,'imagePixelsLoading',jb);break;case hb.STATE_IMAGE_DATA:this.loadingStates[ib]=jb;m.conditionClass(this.root,'imageLoading',jb);break;case hb.STATE_HTML:this.loadingStates[ib]=jb;m.conditionClass(this.root,'dataLoading',jb);this.rhc.setAttribute('aria-busy',jb?'true':'false');break;}},destroy:function(){this.stageHandlers.forEach(function(ib){ib.remove();});if(this.pageHandlers){this.pageHandlers.forEach(function(ib){ib.remove();});this.pageHandlers=null;}},checkState:function(ib){if(ib!=hb.STATE_ERROR&&!this.loadingStates[ib])return;switch(ib){case hb.STATE_IMAGE_DATA:var jb=this.stream.getCurrentImageData();if(jb){var kb=this.getImageURL(jb);if(kb){this.switchImage(kb,null,true);}else if(jb.video)this.switchVideo(jb.video,true);this.setLoadingState(ib,false);}break;case hb.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.showPagers(hb.PAGER_FADE);this.setLoadingState(ib,false);}break;default:if(this.stream.errorInCurrent()){m.hide(this.image);m.show(this.errorBox);}break;}},buttonListener:function(event){var ib=event.getTarget(),jb=Date.now();if(z.byClass(ib,'fbPhotoTagApprovalBox'))return;if(z.byClass(ib,'fbPhotosCornerWantButton')){event.stop();return;}if(jb-this.lastPage<350)return;if(z.byClass(ib,'fbPhotosPhotoLike')){this.likePhoto();}else if(z.byClass(ib,'tagApproveIgnore'))this.updateTagBox(event,ib);},likePhoto:function(){ba.addButtonLike();var ib=oa('fbPhotoSnowliftFeedback'),jb=o.scry(ib,'button.like_link')[0];if(!jb)if(this.redesign){jb=o.scry(this.root,"a._6k6")[0];}else jb=o.scry(ib,'a.UFILikeLink')[0];var kb=jb.getAttribute('href');if(r.isFullScreen())if(ma.chrome())jb.setAttribute('href','javascript:;');jb.click();jb.setAttribute('href',kb);},toggleLikeButton:function(){var ib=o.scry(this.buttonActions,'a.fbPhotosPhotoLike')[0];if(ib){var jb=o.find(this.root,'.likeCount'),kb=o.find(jb,'.likeCountNum');if(jb)if(m.hasClass(ib,'viewerLikesThis')){o.setContent(kb,parseInt(kb.textContent,10)-1);}else o.setContent(kb,parseInt(kb.textContent,10)+1);m.toggleClass(ib,'viewerLikesThis');m.removeClass(ib,'viewerAlreadyLikedThis');}},likePhotoWithKey:function(){if(this.isShowingLikePhotoConfirmation)return;if(this.skipLikePhotoConfirmation){this.likePhoto();}else h.send(new i('/photos/confirm_like.php'),function(ib){this.isShowingLikePhotoConfirmation=true;ib.subscribe('confirm',this.onCloseLikePhotoConfirmDialog.bind(this));ib.subscribe('cancel',this.onCloseLikePhotoConfirmDialog.bind(this));}.bind(this));return false;},likePhotoSkipConfirmation:function(ib){this.skipLikePhotoConfirmation=ib;this.likePhoto();},onCloseLikePhotoConfirmDialog:function(){this.isShowingLikePhotoConfirmation=false;},updateTagBox:function(ib,jb){this.unhiliteAllTags();var kb=wa(ib);if(!kb)return;m.addClass(kb,'tagBox');m.addClass(kb,'tagBoxPendingResponse');m.removeClass(kb,'tagBoxPending');m.hide(o.find(kb,'span.tagForm'));if(jb){m.show(o.find(kb,'span.tagApproved'));}else m.show(o.find(kb,'span.tagIgnored'));},rotate:function(ib){var jb=this.stream.getCursor();if(this.getVideoOnStage()){var kb=(ib=='left')?270:90;cb.isTruthy(this.videoRotateURI,"Video rotate URI not set.");j.loadModules(['VideoRotate'],function(mb){new mb(jb,this.videoRotateURI).motionRotate(kb);}.bind(this));return;}var lb=ra({fbid:jb,opaquecursor:this.stream.getOpaqueCursor(jb),cs_ver:aa.VIEWER_SNOWLIFT},this.stream.getPhotoSetQuery());lb[ib]=1;this.setLoadingState(hb.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);m.hide(this.image);new i('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(lb).setErrorHandler(this.rotationError.bind(this,jb)).setFinallyHandler(this.rotationComplete.bind(this,jb)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(ib,jb){if(ib==this.stream.getCursor()){this.setLoadingState(hb.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));this.swapData();}},rotationError:function(ib,jb){if(ib==this.stream.getCursor()){this.setLoadingState(hb.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));j.loadModules(['AsyncResponse'],function(kb){kb.defaultErrorHandler(jb);});}},saveTagsFromPayload:function(ib){this.storeFromData(ib);if('data' in ib&&this.stream.getCursor() in ib.data)this.swapData();},saveEdit:function(){if(!m.hasClass(this.root,'fbPhotoSnowliftEditMode'))return;j.loadModules(['PhotoInlineEditor','Form'],function(ib,jb){var kb=ib.getInstance(this.getViewerConst());kb&&jb.bootstrap(kb.getForm().controller);}.bind(this));},mouseLeaveListener:function(event){this.unhiliteAllTags();this.reHilitePendingTag();},hilitePagerOnMouseMove:function(event){var ib=na.getEventPosition(event),jb=na.getElementPosition(this.stage);if(x.isRTL()){var kb=na.getElementDimensions(this.stage);this.stagePagerPrev=kb.x-(ib.x-jb.x)<hb.GOPREV_AREA;}else this.stagePagerPrev=ib.x-jb.x<hb.GOPREV_AREA;m.conditionClass(this.prevPager,'hilightPager',this.stagePagerPrev);m.conditionClass(this.nextPager,'hilightPager',!this.stagePagerPrev);var lb,mb=event.getTarget();if(!z.byClass(mb,'snowliftOverlay')&&!z.byClass(mb,'bottomBarActions')&&!z.byClass(mb,'snowliftPager'))lb=hb.PAGER_FADE;this.showPagers(lb);},showPagers:function(ib){clearTimeout(this.fadePagerTimer);this.setStagePagersState('active');if(typeof ib!=='undefined')this.fadePagerTimer=this.hidePagers.bind(this).defer(ib);},hidePagers:function(){var ib=o.scry(this.getRoot(),'.fbPhotosPhotoActionsMenu')[0];if(ib)return;clearTimeout(this.fadePagerTimer);this.setStagePagersState('inactive');},getTagger:function(){if(!this.PhotoTagger)return null;var ib=this.PhotoTagger.getInstance(aa.VIEWER_SNOWLIFT);if(!ib||!ib.tagHoverFacebox)return null;return ib;},hiliteAllBoxes:function(){o.scry(this.stage,'div.tagsWrapper div.faceBox').forEach(function(ib){m.addClass(ib,'otherActive');});},flashAllTags:function(){var ib=this.stream.getCurrentImageData().info.fbid;if(this.sessionPhotosHilited[ib])return;o.scry(this.stage,'div.tagsWrapper div.tagBox').forEach(function(jb){m.addClass(jb,'hover');});this.sessionPhotosHilited[ib]=true;this.unhiliteTimer=this.unhiliteAllTags.bind(this).defer(2000,true);},unhiliteAllTags:function(){clearTimeout(this.unhiliteTimer);o.scry(this.stage,'div.tagsWrapper div.hover').forEach(function(jb){m.removeClass(jb,'hover');});if(this.hilitAllTagsAndBoxesOnHover)o.scry(this.stage,'div.tagsWrapper div.otherActive').forEach(function(jb){m.removeClass(jb,'otherActive');});this.hilitedTag=null;this.showingTypeaheadSuggestions=false;if(!m.hasClass(this.root,'taggingMode')){var ib=this.getTagger();if(ib){ib.hideTagger();ib.setCurrentFacebox(null);}}},switchHilitedTags:function(ib,jb){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}this.unhiliteAllTags();if(this.hilitAllTagsAndBoxesOnHover)this.hiliteAllBoxes();var kb=wa(ib);if(kb){this.hilitedTag=ib;if(!m.hasClass(this.root,'taggingMode')&&ea.isFacebox(this.hilitedTag)){var lb=this.getTagger();if(lb){m.addClass(kb,'hover');var mb=lb.getFacebox(ib);lb.setCurrentFacebox(mb);if(mb)lb.addTagFromFacebox(mb);}}else m.addClass(kb,'hover');if(m.hasClass(kb,'tagBoxPending')&&!m.hasClass(kb,'showPendingTagName')&&jb===true){o.scry(this.stage,'div.tagsWrapper div.showPendingTagName').forEach(function(nb){m.removeClass(nb,'showPendingTagName');});m.addClass(kb,'showPendingTagName');}}},reHilitePendingTag:function(){var ib=wa(this.hilitedTag);if(ib&&m.hasClass(ib,'showPendingTagName'))return;var jb=o.scry(this.stage,'div.tagsWrapper div.showPendingTagName')[0];if(jb)this.switchHilitedTags(jb.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var ib=event.getTarget();if(z.byClass(ib,'snowliftOverlay')||z.byClass(ib,'fbPhotoSnowliftTagApproval')||z.byClass(ib,'tagPointer')||z.byClass(ib,'arrow')||z.byClass(ib,'faceboxSuggestion')||z.byClass(ib,'typeaheadWrapper')||z.byClass(ib,'photoTagTypeahead'))return;var jb=z.byClass(ib,'tagBoxPending'),kb=false;if(this.hilitedTag){var lb=wa(this.hilitedTag);kb=lb&&m.hasClass(lb,'tagBoxPending');}var mb=((!this.hilitedTag&&jb)||(!kb&&jb));if(mb){this.switchHilitedTags(jb.id);return;}if(jb&&(jb.id==this.hilitedTag))return;var nb=250,ob=15,pb=na.getEventPosition(event);if(!this.startingMousePos)this.startingMousePos=pb;var qb=ea.absoluteToNormalizedPosition(this.image,pb);if(!this.haveLeftBufferRegion&&this.startingMousePos.distanceTo(pb)<ob){return;}else this.haveLeftBufferRegion=true;if(this.currentTagHasPrecedence(qb))return;var rb=ea.getNearestBox(this.stream.getCurrentExtraData().tagRects,qb);if(!rb){if(!kb){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var sb=null;if(kb){var tb={};tb[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];sb=ea.getNearestBox(tb,qb);}if(sb!==null&&kb)return;if(this.hilitedTag!=rb)if(kb){this.switchTimer=this.switchHilitedTags.bind(this,rb).defer(nb);}else{if(this.showHover){if(!this.seenTags)this.seenTags=[];if(!this.seenTags[rb]){ba.addFaceTagImpression();this.seenTags[rb]=true;}}this.switchHilitedTags(rb);}},currentTagHasPrecedence:function(ib){if(!this.hilitedTag)return false;if(this.stream.getCurrentExtraData().tagRects[this.hilitedTag]===undefined){this.hilitedTag=null;return false;}var jb=this.stream.getCurrentExtraData().tagRects[this.hilitedTag],kb=new ga(jb.t+(jb.h()/2),jb.r,jb.b+(ea.isFacebox(this.hilitedTag)?10:0),jb.l,jb.domain);return kb.contains(ib);},getVideoOnStage:function(){var ib=this.stream&&this.stream.getCurrentImageData();return ib&&ib.video;},shouldPageOnAction:function(ib,jb){if(!this.isOpen||this.isShowingLikePhotoConfirmation)return false;var kb=o.isNode(jb)&&(z.byClass(jb,'snowliftPager')||z.byClass(jb,'stagePagers')||z.byClass(jb,'pivotPageColumn')),lb=o.isNode(jb)&&z.byClass(jb,'stage'),mb=m.hasClass(jb,'faceBox'),nb=(!m.hasClass(this.root,'taggingMode')&&mb&&!kb);if(nb&&this.shouldKeepFacebox){if(!this.showingTypeaheadSuggestions){this.getTagger().updateWithSuggestions();(function(){o.find(this.getTagger().tagger,'input.textInput').focus();}).bind(this).defer();}this.showingTypeaheadSuggestions=!this.showingTypeaheadSuggestions;return false;}var ob=((lb&&m.hasClass(this.root,'taggingMode'))||z.byClass(jb,'tagBoxPending')||z.byClass(jb,'tagBoxPendingResponse')||z.byClass(jb,'fbPhotoTagApprovalBox')||z.byClass(jb,'tag')||(this.cropper&&this.cropper.croppingMode));if(ob)return false;return ib==u.LEFT||ib==u.RIGHT||ib==db||ib==eb||kb||nb||lb;},keyHandler:function(ib,event){if(event.getModifiers().any||v.getTopmostLayer()!==this.spotlight)return true;switch(q.getKeyCode(event)){case u.LEFT:case u.RIGHT:case db:case eb:if(!this.pagersOnKeyboardNav)this.showPagers(hb.PAGER_FADE);this.pageListener(event);return false;case fb:return this.toggleFullScreen();case gb:return this.likePhotoWithKey();}},shouldHandlePendingTag:function(event){var ib=this.getTagger();if(!ib||!ib.tags.length)return false;var jb=ea.absoluteToNormalizedPosition(this.getImage(),na.getEventPosition(event)),kb=ib.findNearestTag(jb);if(!kb||!m.hasClass(kb.node,'tagBoxPending'))return false;g.inform('PhotoTagApproval.PENDING_TAG_PHOTO_CLICK',{id:kb.id,version:this.getVersionConst()});return true;},pageListener:function(event){var ib=q.getKeyCode(event),jb=event.getTarget();if(!this.shouldPageOnAction(ib,jb))return;if(this.shouldHandlePendingTag(event))return;var kb=0;if(ib==u.RIGHT||ib==eb){kb=1;ba.setPagingAction('key_right');}else if(ib==u.LEFT||ib==db){kb=-1;ba.setPagingAction('key_left');}else if(z.byClass(jb,'next')){kb=1;ba.setPagingAction('click_next');}else if(z.byClass(jb,'prev')){kb=-1;ba.setPagingAction('click_prev');}else if(!this.stagePagerPrev){kb=1;ba.setPagingAction('click_stage');}else{kb=-1;ba.setPagingAction('click_stage_back');}var lb=o.scry(this.ufiForm,'input.mentionsHidden'),mb=false;for(var nb=0;nb<lb.length;nb++)if(!s.isEmpty(lb[nb])){mb=true;break;}if(mb||m.hasClass(this.root,'fbPhotoSnowliftEditMode')||(this.cropper&&this.cropper.croppingMode)){this.warnLeavePage(kb);}else{this.page(kb,ma.chrome()&&r.isFullScreen());bb('snowlift',jb,event).uai(ba.pagingAction);}},warnLeavePage:function(ib){new n().setTitle("Are you sure you want to leave this page?").setBody("You have unsaved changes that will be lost if you leave the page.").setButtons([{name:'leave_page',label:"Leave this Page",handler:this.page.bind(this,ib)},{name:'continue_editing',label:"Stay on this Page",className:'inputaux'}]).setModal(true).show();},getUsesOpaqueCursor:function(){return this.stream.getUsesOpaqueCursor();},getOpaqueCursor:function(ib){return this.stream.getOpaqueCursor(ib);},setReachedLeftEnd:function(){this.stream.setReachedLeftEnd();},setReachedRightEnd:function(){this.stream.setReachedRightEnd();},page:function(ib,jb){if(!this.stream.isValidMovement(ib)||!this.stream.nonCircularPhotoSetCanPage(ib)){this.showPagers(hb.PAGER_FADE);return;}this.lastPage=Date.now();this.unhiliteAllTags();this.seenTags=[];this.startingMousePos=null;this.haveLeftBufferRegion=false;var kb=this.getVideoOnStage();if(kb)this.switchVideo(kb,false);if(this.pivots&&this.pivots.page(ib))return;g.inform('PhotoSnowlift.PAGE');ja.hide();this.recacheData();this.stream.moveCursor(ib);m.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(hb.STATE_HTML,true);m.show(this.errorBox);return;}var lb=this.stream.getCurrentImageData();if(lb){var mb=this.getImageURL(lb);if(mb){this.switchImage(mb,null,true);}else if(lb.video)this.switchVideo(lb.video,true);if(!jb){this.replaceUrl=true;xa(lb.info.permalink);}this.setLoadingState(hb.STATE_IMAGE_DATA,false);}else{this.setLoadingState(hb.STATE_IMAGE_PIXELS,true);this.setLoadingState(hb.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(hb.STATE_HTML,true);this.disableAds=this.disableAdsForSession;this.loadAds();if(this.cropper)this.cropper.resetPhoto();this.setLeftAndRightPagersState();},logImpressionDetailsForPhoto:function(){var ib=[].concat(o.scry(oa('fbPhotoSnowliftTagList'),'input.photoImpressionDetails'),o.scry(oa('fbPhotoSnowliftFeedback'),'input.photoImpressionDetails'));if(ib.length===0)return;var jb={};for(var kb=0;kb<ib.length;kb++)jb[ib[kb].name]=ib[kb].value;if(this.getVideoOnStage()){jb.width=0;jb.height=0;}else{var lb=this.getImageDimensions(this.stream.getCurrentImageData());jb.width=lb.x;jb.height=lb.y;}ba.addDetailData(this.stream.getCursor(),jb);ca.setIsLogAdData(true);},loadAds:function(){if(this.disableAds)return;ca.loadAdsFromUserActivity();},transitionHandler:function(ib){if(ib.getQueryData().closeTheater||ib.getQueryData().permPage||ib.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(za(ib.getPath(),'/hashtag/')){this.close();y.transitionComplete(true);return true;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(ib.getQualifiedURI().toString());y.transitionComplete(true);return true;}var jb=this._uriStack.length;if(jb>=2&&this._uriStack[jb-2]==ib.getQualifiedURI().toString())this._uriStack.pop();var kb=this.stream.getCursorForURI(ib.getUnqualifiedURI().toString());if(kb){var lb=this.stream.getRelativeMovement(kb);this.page(lb,true);y.transitionComplete(false);return true;}if(this.isOpen){y.transitionComplete(true);this.close();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var ib=this.stream.getCurrentHtml();for(var jb in ib){ib[jb]=sa(oa(jb).childNodes);o.empty(oa(jb));}}},reloadIfTimeout:function(){if(!t.hasLoaded(this.image)){var ib=this.makeNewImage(this.image.src,true);q.listen(ib,'load',this.useImage.bind(this,ib,null,true));}},useImage:function(ib,jb,kb){if(kb&&t.hasLoaded(this.image))return;o.replace(this.image,ib);this.image=ib;g.inform('Amoeba/instrument',[this.image,'image'],g.BEHAVIOR_PERSISTENT);this.adjustStageSize(jb);},makeNewImage:function(ib,jb){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!jb)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),hb.LOADING_TIMEOUT);var kb=o.create('img',{className:'spotlight',alt:''});kb.setAttribute('aria-describedby','fbPhotosSnowliftCaption');kb.setAttribute('aria-busy','true');q.listen(kb,'load',pa(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){if(this.isOpen){this.adjustStageSize();this.adjustForNewData();}}).bind(this).defer();}.bind(this),'photo_theater'));kb.src=ib;return kb;},switchImage:function(ib,jb,kb){m.hide(this.image);m.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var lb=this.stream&&this.stream.getCurrentImageData();if(lb)ba.addPhotoView(lb.info,this.shouldShowHiRes(lb),this.fullscreen&&r.isFullScreen());this.useImage(this.makeNewImage(ib,false),jb,false);if(kb)this.stream.preloadImages(this.shouldShowHiRes(lb));if(this.cropper&&this.cropper.croppingMode)this.cropper.resetPhoto();g.inform('PhotoSnowlift.SWITCH_IMAGE');},switchVideo:function(ib,jb){var kb='swf_'+ib;if(jb){m.addClass(this.stageWrapper,'showVideo');var lb=o.create('div',{className:'videoStageContainer'});o.appendContent(this.videoStage,lb);lb.id=ib;if(window[kb]&&!wa(kb))window[kb].write(ib);var mb='video_warning_'+ib,nb=wa(ib);if(!this.videoWarnings)this.videoWarnings=[];if(nb&&this.videoWarnings[mb])o.setContent(nb,this.videoWarnings[mb]);this.adjustStageSizeForVideo.bind(this,kb).defer();}else{window[kb]&&window[kb].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);o.empty(this.videoStage);m.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(ib){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);var jb=this.getVideoOnStage();if(!jb){return;}else{var kb='swf_'+jb;if(ib!==kb)return;this.adjustStageSizeForVideo(ib);}},adjustStageSizeForVideo:function(ib){var jb=wa(ib);if(!jb){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,ib),200);}else this.adjustStageSize(new na(jb.width,jb.height));},handleServerError:function(ib,jb){o.setContent(this.errorBox,ib);this.storeFromData(jb);},swapData:function(){var ib,jb=this.stream.getCurrentHtml();if(jb){this.setLoadingState(hb.STATE_HTML,false);for(var kb in jb){ib=wa(kb);ib&&o.setContent(ib,jb[kb]);}g.inform('PhotoSnowlift.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoSnowlift.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);}this.adjustScroller();this.adjustStageSize();this.scrollableArea.showScrollbar(false);this.adjustForNewData();this.logImpressionDetailsForPhoto();if(this.showFlashTags)this.flashAllTags();},updateTotalCount:function(ib,jb,kb){var lb=this.stream.getCurrentHtml();if(lb){var mb=oa('fbPhotoSnowliftPositionAndCount');o.replace(mb,kb);mb=kb;m.show(mb);var nb='fbPhotoSnowliftPositionAndCount';lb[nb]=sa(mb.childNodes);}this.stream.setTotalCount(ib);this.stream.setFirstCursorIndex(jb);},addPhotoFbids:function(ib,jb,kb,lb){if(lb&&this.sessionID&&lb!=this.sessionID)return;var mb=this.stream.getCursor()===null;this.stream.attachToFbidsList(ib,jb,kb);if(kb&&mb)this.page(0,true);if(this.pivots&&kb)this.pivots.setCycleCount(this.stream.calculateDistance(this.stream.getCursor(),this.stream.firstCursor));if(!this.pagersShown&&this.stream.canPage())this.setStagePagersState('ready');this.setLeftAndRightPagersState();},attachTagger:function(ib){o.appendContent(this.stageActions,ib);},storeFromData:function(ib){if(!this.isOpen)return;if(ib.ssid&&this.sessionID&&this.sessionID!=ib.ssid)return;var jb=this.stream.storeToCache(ib);if('error' in jb){this.checkState(hb.STATE_ERROR);return;}if('init' in jb){this.initDataFetched(jb.init);if(this.openExplicitly){this.replaceUrl=true;xa(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersState('ready');this.setLeftAndRightPagersState();this.ua&&this.ua.add_event('ufi');}if('image' in jb)this.checkState(hb.STATE_IMAGE_DATA);if('data' in jb)this.checkState(hb.STATE_HTML);},setLeftAndRightPagersState:function(){if(this.stream.isNonCircularPhotoSet()){m.conditionClass(this.root,'disableLeft',!this.stream.nonCircularPhotoSetCanPage(-1));m.conditionClass(this.root,'disableRight',!this.stream.nonCircularPhotoSetCanPage(1));}},setStagePagersState:function(ib){switch(ib){case 'ready':m.addClass(this.root,'pagingReady');this.pagersShown=true;this.ua&&this.ua.add_event('arrows');return;case 'active':m.addClass(this.root,'pagingActivated');return;case 'inactive':m.removeClass(this.root,'pagingActivated');return;case 'disabled':case 'reset':m.removeClass(this.root,'pagingReady');return;}},deletePhoto:function(ib){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();},onHiliteTag:function(ib,jb){if(jb.version!=aa.VIEWER_SNOWLIFT)return;var kb=jb.tag;if(kb)this.switchHilitedTags(kb,true);},onUpdateTagBox:function(ib,jb){if(jb.version==aa.VIEWER_SNOWLIFT)this.updateTagBox(jb.id,jb.approve);}});e.exports=hb;});
__d("Spotlight",["Arbiter","ArbiterMixin","DOM","JSXDOM","Layer","LayerAutoFocus","LayerTabIsolation","ModalLayer","Vector","classWithMixins","copyProperties","csx","cx","mixin"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('DOM'),j=b('JSXDOM'),k=b('Layer'),l=b('LayerAutoFocus'),m=b('LayerTabIsolation'),n=b('ModalLayer'),o=b('Vector'),p=b('classWithMixins'),q=b('copyProperties'),r=b('csx'),s=b('cx'),t=b('mixin'),u=p(k,t(h));for(var v in u)if(u.hasOwnProperty(v)&&v!=="_metaprototype")x[v]=u[v];var w=u===null?null:u.prototype;x.prototype=Object.create(w);x.prototype.constructor=x;x.__superConstructor__=u;function x(z,aa){u.call(this,z,aa);this.stageMinSize=new o(0,0);this.stagePadding=new o(0,0);}x.prototype._buildWrapper=function(z,aa){return (j.div({className:"_n8 _3qx"},j.div({className:"_n9"},aa)));};x.prototype._getDefaultBehaviors=function(){return w._getDefaultBehaviors.call(this).concat([y,l,m,n]);};x.prototype.getContentRoot=function(){if(!this._content)this._content=i.find(this.getRoot(),"div._n3");return this._content;};x.prototype.configure=function(z){if(z.stageMinSize)this.stageMinSize=z.stageMinSize;if(z.stagePadding)this.stagePadding=z.stagePadding;};x.prototype.onContentLoaded=function(){this.inform('content-load');};x.prototype.updatePermalink=function(z){this.inform('permalinkchange',z);};q(x.prototype,{stageMinSize:null,stagePadding:null});function y(z){this._layer=z;}y.prototype.enable=function(){this._subscription=this._layer.subscribe(['show','hide'],function(z,aa){if(z==='show'){g.inform('layer_shown',{type:'Spotlight'});}else g.inform('layer_hidden',{type:'Spotlight'});});};y.prototype.disable=function(){this._subscription.unsubscribe();this._subscription=null;};q(y.prototype,{_subscription:null});e.exports=x;});